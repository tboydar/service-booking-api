# Jaeger åˆ†å¸ƒå¼è¿½è¹¤ç³»çµ±

## ğŸ“‹ æ¦‚è¿°

Jaeger æ˜¯ä¸€å€‹é–‹æºçš„åˆ†å¸ƒå¼è¿½è¹¤ç³»çµ±ï¼Œç”¨æ–¼ç›£æ§å’Œè¨ºæ–·å¾®æœå‹™æ¶æ§‹ä¸­çš„æ•ˆèƒ½å•é¡Œã€‚æœ¬é…ç½®ä½¿ç”¨ç°¡åŒ–çš„å–®å®¹å™¨éƒ¨ç½²æ–¹æ¡ˆï¼Œæ¡ç”¨ BadgerDB ä½œç‚ºæœ¬åœ°æª”æ¡ˆå„²å­˜ï¼Œç„¡éœ€å¤–éƒ¨ä¾è³´ã€‚

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1. å•Ÿå‹• Jaeger

```bash
# é€²å…¥ jaeger ç›®éŒ„
cd jaeger

# ä½¿ç”¨ docker compose å•Ÿå‹• (Docker Compose V2)
docker compose -f docker-compose-v2.yml up -d

# æª¢æŸ¥æœå‹™ç‹€æ…‹
docker compose -f docker-compose-v2.yml ps
```

### 2. è¨ªå• Jaeger UI

é–‹å•Ÿç€è¦½å™¨è¨ªå•: http://localhost:16686

### 3. é©—è­‰æœå‹™ä¾è³´é—œä¿‚ (Demo)

#### å•Ÿå‹•æ¸¬è©¦æœå‹™
```bash
# å•Ÿå‹•ä¸»æœå‹™
npm run dev

# å•Ÿå‹•æ¨¡æ“¬æ”¯ä»˜æœå‹™ (å¦ä¸€å€‹çµ‚ç«¯)
node payment-service.js
```

#### ç”¢ç”Ÿè¿½è¹¤æ•¸æ“š
```bash
# å‰µå»ºæ¸¬è©¦æœå‹™å’Œé ç´„
curl -X POST http://localhost:3000/booking/create \
  -H "Content-Type: application/json" \
  -d '{"serviceId": "test-service-001", "userId": "demo-user", "date": "2025-09-20", "time": "14:00"}'
```

#### æŸ¥çœ‹çµæœ
- **æœå‹™åˆ—è¡¨**: http://localhost:16686/search
- **ä¾è³´é—œä¿‚åœ–**: http://localhost:16686/dependencies
- **è¿½è¹¤è©³æƒ…**: é¸æ“‡ä»»ä¸€ trace æŸ¥çœ‹å®Œæ•´èª¿ç”¨éˆ

### 4. åœæ­¢æœå‹™

```bash
docker compose -f docker-compose-v2.yml down
```

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     OpenTelemetry      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚     Protocol (OTLP)     â”‚                â”‚
â”‚  Your App       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚    Jaeger      â”‚
â”‚  (Node.js/Koa)  â”‚         :4318           â”‚   Collector    â”‚
â”‚                 â”‚                          â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                                      â–¼
                                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                             â”‚   BadgerDB     â”‚
                                             â”‚ (Local Storage)â”‚
                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                                      â–¼
                                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                             â”‚  Jaeger UI     â”‚
                                             â”‚    :16686      â”‚
                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’¾ å„²å­˜æ–¹æ¡ˆèªªæ˜

### BadgerDB ç‰¹é»

- **åµŒå…¥å¼è³‡æ–™åº«**: é¡ä¼¼ SQLiteï¼Œç„¡éœ€é¡å¤–çš„è³‡æ–™åº«æœå‹™
- **æœ¬åœ°æª”æ¡ˆå„²å­˜**: è³‡æ–™å„²å­˜åœ¨ `./data` ç›®éŒ„
- **è‡ªå‹•å£“ç¸®**: å…§å»ºè³‡æ–™å£“ç¸®åŠŸèƒ½
- **é«˜æ•ˆèƒ½**: LSM tree æ¶æ§‹ï¼Œå¯«å…¥æ•ˆèƒ½å„ªç§€
- **è³‡æ–™æŒä¹…åŒ–**: å®¹å™¨é‡å•Ÿå¾Œè³‡æ–™ä¿ç•™

### è³‡æ–™ç›®éŒ„çµæ§‹

```
jaeger/data/
â”œâ”€â”€ key/      # ç´¢å¼•è³‡æ–™
â””â”€â”€ value/    # è¿½è¹¤è³‡æ–™
```

## ğŸ“Š é æœŸæ•ˆç›Š

### 1. æ•ˆèƒ½åˆ†æ ğŸš€
- **è­˜åˆ¥æ…¢æŸ¥è©¢**: å¿«é€Ÿæ‰¾å‡ºè³‡æ–™åº«æŸ¥è©¢ç“¶é ¸
- **API å»¶é²åˆ†æ**: åˆ†ææ¯å€‹ API ç«¯é»çš„éŸ¿æ‡‰æ™‚é–“
- **è³‡æºä½¿ç”¨ç›£æ§**: äº†è§£ç³»çµ±è³‡æºä½¿ç”¨æƒ…æ³

### 2. æ•…éšœè¨ºæ–· ğŸ”
- **éŒ¯èª¤è¿½è¹¤**: è¿½è¹¤éŒ¯èª¤ç™¼ç”Ÿçš„å®Œæ•´è·¯å¾‘
- **æ ¹å› åˆ†æ**: å¿«é€Ÿå®šä½å•é¡Œæ ¹æº
- **æ¸›å°‘ MTTR**: å¹³å‡ä¿®å¾©æ™‚é–“å¾å°æ™‚ç¸®çŸ­åˆ°åˆ†é˜

### 3. ç³»çµ±ç†è§£ ğŸ“ˆ
- **æœå‹™ä¾è³´åœ–**: è¦–è¦ºåŒ–æœå‹™é–“çš„èª¿ç”¨é—œä¿‚
- **è«‹æ±‚æµç¨‹åœ–**: äº†è§£è«‹æ±‚åœ¨ç³»çµ±ä¸­çš„å®Œæ•´æµç¨‹
- **æ•ˆèƒ½è¶¨å‹¢**: é•·æœŸæ•ˆèƒ½è³‡æ–™åˆ†æ

### 4. é–‹ç™¼æ•ˆç‡æå‡ âš¡
- **æ¸›å°‘é™¤éŒ¯æ™‚é–“**: 50-70% çš„é™¤éŒ¯æ™‚é–“ç¯€çœ
- **ä¸»å‹•ç™¼ç¾å•é¡Œ**: åœ¨ç”¨æˆ¶å ±å‘Šå‰ç™¼ç¾æ•ˆèƒ½å•é¡Œ
- **å„ªåŒ–æ±ºç­–æ”¯æ´**: åŸºæ–¼è³‡æ–™çš„æ•ˆèƒ½å„ªåŒ–æ±ºç­–

## ğŸ”§ æ‡‰ç”¨ç¨‹å¼æ•´åˆ

### å®‰è£å¿…è¦å¥—ä»¶

```bash
npm install --save \
  @opentelemetry/api \
  @opentelemetry/sdk-node \
  @opentelemetry/auto-instrumentations-node \
  @opentelemetry/exporter-trace-otlp-http
```

### åŸºæœ¬æ•´åˆç¯„ä¾‹

åƒè€ƒ `integration/` ç›®éŒ„ä¸­çš„ç¯„ä¾‹ç¨‹å¼ç¢¼ï¼š

1. **tracing.ts** - OpenTelemetry SDK åˆå§‹åŒ–
2. **middleware.ts** - Koa ä¸­ä»‹è»Ÿé«”æ•´åˆ

### ç’°å¢ƒè®Šæ•¸é…ç½®

```env
# Jaeger ç«¯é»é…ç½®
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318
OTEL_SERVICE_NAME=service-booking-api
OTEL_TRACES_EXPORTER=otlp

# å–æ¨£ç‡è¨­å®š (0.0 - 1.0)
OTEL_TRACES_SAMPLER=parentbased_traceidratio
OTEL_TRACES_SAMPLER_ARG=0.1  # 10% å–æ¨£ç‡
```

## ğŸŒ é ç«¯éƒ¨ç½²æŒ‡å—

### åœ¨é ç«¯ä¼ºæœå™¨éƒ¨ç½²

1. **è¤‡è£½é…ç½®æª”æ¡ˆ**
```bash
scp -r jaeger/ user@remote-server:/path/to/deployment/
```

2. **åœ¨é ç«¯å•Ÿå‹•æœå‹™**
```bash
ssh user@remote-server
cd /path/to/deployment/jaeger
docker-compose -f docker-compose-v2.yml up -d
```

3. **é…ç½®é˜²ç«ç‰†** (å¦‚éœ€è¦)
```bash
# é–‹æ”¾ Jaeger UI ç«¯å£
sudo ufw allow 16686/tcp

# é–‹æ”¾ OTLP ç«¯å£ (ç”¨æ–¼æ¥æ”¶è¿½è¹¤è³‡æ–™)
sudo ufw allow 4318/tcp
```

### å¾æœ¬åœ°é€£æ¥åˆ°é ç«¯ Jaeger

ä¿®æ”¹ç’°å¢ƒè®Šæ•¸æŒ‡å‘é ç«¯æœå‹™å™¨ï¼š

```env
OTEL_EXPORTER_OTLP_ENDPOINT=http://remote-server-ip:4318
```

## ğŸ“ é…ç½®èªªæ˜

### ç«¯å£èªªæ˜

| ç«¯å£ | å”è­° | ç”¨é€” |
|------|------|------|
| 16686 | HTTP | Jaeger UI Web ä»‹é¢ |
| 4317 | gRPC | OpenTelemetry Protocol (OTLP) |
| 4318 | HTTP | OpenTelemetry Protocol (OTLP) |
| 14268 | HTTP | Jaeger Collector HTTP |
| 14250 | gRPC | Jaeger Collector gRPC |
| 6831 | UDP | Jaeger Agent Compact Thrift |
| 6832 | UDP | Jaeger Agent Binary Thrift |
| 9411 | HTTP | Zipkin ç›¸å®¹ç«¯å£ |

### è³‡æ–™ä¿ç•™ç­–ç•¥

é è¨­è¨­å®šï¼š
- **è³‡æ–™ä¿ç•™æ™‚é–“**: 7 å¤© (168 å°æ™‚)
- **åƒåœ¾å›æ”¶é–“éš”**: 1 å°æ™‚
- **å£“ç¸®ç­–ç•¥**: è‡ªå‹•å£“ç¸®è€èˆŠè³‡æ–™

ä¿®æ”¹ä¿ç•™æ™‚é–“ï¼š
```yaml
environment:
  - BADGER_SPAN_STORE_TTL=168h  # ä¿®æ”¹æ­¤å€¼èª¿æ•´ä¿ç•™æ™‚é–“
```

## âš™ï¸ é€²éšé…ç½®

### è³‡æºé™åˆ¶èª¿æ•´

ç·¨è¼¯ `docker-compose-v2.yml` ä¸­çš„è³‡æºé™åˆ¶ï¼š

```yaml
deploy:
  resources:
    limits:
      cpus: '2'      # å¢åŠ  CPU é™åˆ¶
      memory: 2G     # å¢åŠ è¨˜æ†¶é«”é™åˆ¶
```

### ä½¿ç”¨ Docker Volume (å¯é¸)

å¦‚æœåå¥½ä½¿ç”¨ Docker ç®¡ç†çš„å·è€Œéæœ¬åœ°ç›®éŒ„ï¼š

```yaml
volumes:
  - jaeger-badger-key:/badger/key
  - jaeger-badger-data:/badger/data

# åœ¨æª”æ¡ˆåº•éƒ¨åŠ å…¥
volumes:
  jaeger-badger-key:
  jaeger-badger-data:
```

### ç”Ÿç”¢ç’°å¢ƒå»ºè­°

1. **å–æ¨£ç­–ç•¥**
   - é–‹ç™¼ç’°å¢ƒ: 100% (1.0)
   - æ¸¬è©¦ç’°å¢ƒ: 50% (0.5)
   - ç”Ÿç”¢ç’°å¢ƒ: 10% (0.1) æˆ–æ›´ä½

2. **è³‡æºé…ç½®**
   - æ ¹æ“šæµé‡èª¿æ•´è¨˜æ†¶é«”å’Œ CPU é™åˆ¶
   - ç›£æ§ç£ç¢Ÿä½¿ç”¨é‡ï¼Œé©æ™‚æ¸…ç†èˆŠè³‡æ–™

3. **å‚™ä»½ç­–ç•¥**
   - å®šæœŸå‚™ä»½ `./data` ç›®éŒ„
   - ä½¿ç”¨ rsync æˆ–å…¶ä»–å·¥å…·åŒæ­¥è³‡æ–™

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

1. **å®¹å™¨ç„¡æ³•å•Ÿå‹•**
   - æª¢æŸ¥ç«¯å£æ˜¯å¦è¢«ä½”ç”¨: `lsof -i :16686`
   - ç¢ºèª Docker æœå‹™æ­£åœ¨é‹è¡Œ: `docker info`

2. **è³‡æ–™æœªæŒä¹…åŒ–**
   - ç¢ºèª `BADGER_EPHEMERAL=false`
   - æª¢æŸ¥ç›®éŒ„æ¬Šé™: `ls -la ./data`

3. **ç„¡æ³•æ¥æ”¶è¿½è¹¤è³‡æ–™**
   - ç¢ºèªæ‡‰ç”¨ç¨‹å¼é…ç½®çš„ç«¯é»æ­£ç¢º
   - æª¢æŸ¥é˜²ç«ç‰†è¦å‰‡
   - æŸ¥çœ‹å®¹å™¨æ—¥èªŒ: `docker-compose logs jaeger`

### æ—¥èªŒæŸ¥çœ‹

```bash
# æŸ¥çœ‹å³æ™‚æ—¥èªŒ
docker-compose -f docker-compose-v2.yml logs -f jaeger

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œæ—¥èªŒ
docker-compose -f docker-compose-v2.yml logs --tail=100 jaeger
```

## ğŸ“š åƒè€ƒè³‡æº

- [Jaeger å®˜æ–¹æ–‡æª”](https://www.jaegertracing.io/docs/)
- [OpenTelemetry Node.js](https://opentelemetry.io/docs/languages/js/)
- [BadgerDB æ–‡æª”](https://dgraph.io/docs/badger/)
- [Docker Compose æ–‡æª”](https://docs.docker.com/compose/)

## ğŸ“„ æˆæ¬Š

æœ¬é…ç½®éµå¾ª MIT æˆæ¬Šæ¢æ¬¾ã€‚