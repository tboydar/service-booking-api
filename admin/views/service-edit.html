<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç·¨è¼¯æœå‹™ - Service Booking API</title>
  <link rel="stylesheet" href="/admin/css/admin.css">
</head>
<body>
  <div class="admin-wrapper">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <h3>ğŸ¯ ç®¡ç†å¾Œå°</h3>
      </div>
      <ul class="sidebar-menu">
        <li><a href="/admin/dashboard">ğŸ“Š å„€è¡¨æ¿</a></li>
        <li><a href="/admin/system">ğŸ’» ç³»çµ±ç›£æ§</a></li>
        <li><a href="/admin/logs">ğŸ“ æ—¥èªŒç®¡ç†</a></li>
        <li><a href="/admin/scheduler">â° æ’ç¨‹ç®¡ç†</a></li>
        <li><a href="/admin/k6-test">ğŸš€ K6 æ•ˆèƒ½æ¸¬è©¦</a></li>
        <li><a href="/admin/services" class="active">ğŸ“¦ æœå‹™ç®¡ç†</a></li>
        <li><a href="/admin/users">ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</a></li>
        <li><a href="#" id="logoutBtn">ğŸšª ç™»å‡º</a></li>
      </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="header">
        <h1>âœï¸ ç·¨è¼¯æœå‹™</h1>
        <a href="/admin/services" class="btn btn-secondary">ğŸ”™ è¿”å›æœå‹™åˆ—è¡¨</a>
      </div>

      <!-- Loading indicator -->
      <div id="loadingIndicator" class="loading-overlay">
        <div class="spinner"></div>
        <p>è¼‰å…¥æœå‹™è³‡æ–™ä¸­...</p>
      </div>

      <!-- Service Form -->
      <div class="card" id="serviceFormCard" style="display: none;">
        <div class="card-header">
          <h2 class="card-title">ğŸ“ æœå‹™è³‡è¨Š</h2>
        </div>
        <div class="card-body">
          <form id="serviceForm">
            <div class="form-grid">
              <div class="form-group">
                <label for="serviceName">æœå‹™åç¨± *</label>
                <input type="text" id="serviceName" class="form-control" required>
              </div>

              <div class="form-group">
                <label for="serviceCategory">æœå‹™é¡åˆ¥</label>
                <select id="serviceCategory" class="form-control">
                  <option value="consulting">è«®è©¢æœå‹™</option>
                  <option value="maintenance">ç¶­è­·æœå‹™</option>
                  <option value="installation">å®‰è£æœå‹™</option>
                  <option value="training">åŸ¹è¨“æœå‹™</option>
                  <option value="support">æŠ€è¡“æ”¯æ´</option>
                  <option value="other">å…¶ä»–</option>
                </select>
              </div>

              <div class="form-group">
                <label for="servicePrice">åƒ¹æ ¼ (NT$) *</label>
                <input type="number" id="servicePrice" class="form-control" min="0" step="1" required>
              </div>

              <div class="form-group">
                <label for="serviceDuration">æœå‹™æ™‚é•· (åˆ†é˜) *</label>
                <input type="number" id="serviceDuration" class="form-control" min="15" step="15" required>
              </div>

              <div class="form-group full-width">
                <label for="serviceDescription">æœå‹™æè¿°</label>
                <textarea id="serviceDescription" class="form-control" rows="4"
                         placeholder="è«‹æè¿°æ­¤æœå‹™çš„è©³ç´°å…§å®¹ã€é©ç”¨å°è±¡ç­‰..."></textarea>
              </div>

              <div class="form-group">
                <label for="serviceLocation">æœå‹™åœ°é»</label>
                <select id="serviceLocation" class="form-control">
                  <option value="onsite">å®¢æˆ¶ç¾å ´</option>
                  <option value="remote">é ç«¯æœå‹™</option>
                  <option value="office">å…¬å¸è¾¦å…¬å®¤</option>
                  <option value="flexible">å½ˆæ€§å®‰æ’</option>
                </select>
              </div>

              <div class="form-group">
                <label for="maxBookings">æ¯æ—¥æœ€å¤§é ç´„æ•¸</label>
                <input type="number" id="maxBookings" class="form-control" min="1" max="50" value="5">
              </div>

              <div class="form-group">
                <label for="advanceBooking">æå‰é ç´„å¤©æ•¸</label>
                <input type="number" id="advanceBooking" class="form-control" min="0" max="365" value="1">
              </div>

              <div class="form-group">
                <label for="serviceStatus">æœå‹™ç‹€æ…‹</label>
                <select id="serviceStatus" class="form-control">
                  <option value="true">å•Ÿç”¨</option>
                  <option value="false">åœç”¨</option>
                </select>
              </div>
            </div>

            <div class="form-section">
              <h3>ğŸ“… æœå‹™æ™‚æ®µè¨­å®š</h3>
              <div class="time-slots">
                <div class="day-schedule" data-day="monday">
                  <label class="day-label">
                    <input type="checkbox" class="day-checkbox" checked> é€±ä¸€
                  </label>
                  <input type="time" class="time-start" value="09:00">
                  <span>è‡³</span>
                  <input type="time" class="time-end" value="17:00">
                </div>
                <div class="day-schedule" data-day="tuesday">
                  <label class="day-label">
                    <input type="checkbox" class="day-checkbox" checked> é€±äºŒ
                  </label>
                  <input type="time" class="time-start" value="09:00">
                  <span>è‡³</span>
                  <input type="time" class="time-end" value="17:00">
                </div>
                <div class="day-schedule" data-day="wednesday">
                  <label class="day-label">
                    <input type="checkbox" class="day-checkbox" checked> é€±ä¸‰
                  </label>
                  <input type="time" class="time-start" value="09:00">
                  <span>è‡³</span>
                  <input type="time" class="time-end" value="17:00">
                </div>
                <div class="day-schedule" data-day="thursday">
                  <label class="day-label">
                    <input type="checkbox" class="day-checkbox" checked> é€±å››
                  </label>
                  <input type="time" class="time-start" value="09:00">
                  <span>è‡³</span>
                  <input type="time" class="time-end" value="17:00">
                </div>
                <div class="day-schedule" data-day="friday">
                  <label class="day-label">
                    <input type="checkbox" class="day-checkbox" checked> é€±äº”
                  </label>
                  <input type="time" class="time-start" value="09:00">
                  <span>è‡³</span>
                  <input type="time" class="time-end" value="17:00">
                </div>
                <div class="day-schedule" data-day="saturday">
                  <label class="day-label">
                    <input type="checkbox" class="day-checkbox"> é€±å…­
                  </label>
                  <input type="time" class="time-start" value="09:00" disabled>
                  <span>è‡³</span>
                  <input type="time" class="time-end" value="17:00" disabled>
                </div>
                <div class="day-schedule" data-day="sunday">
                  <label class="day-label">
                    <input type="checkbox" class="day-checkbox"> é€±æ—¥
                  </label>
                  <input type="time" class="time-start" value="09:00" disabled>
                  <span>è‡³</span>
                  <input type="time" class="time-end" value="17:00" disabled>
                </div>
              </div>
            </div>

            <div class="form-info">
              <p><strong>æœå‹™ ID:</strong> <span id="serviceId">-</span></p>
              <p><strong>å»ºç«‹æ™‚é–“:</strong> <span id="createdAt">-</span></p>
              <p><strong>æœ€å¾Œæ›´æ–°:</strong> <span id="updatedAt">-</span></p>
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-secondary" onclick="window.location.href='/admin/services'">å–æ¶ˆ</button>
              <button type="button" class="btn btn-danger" onclick="deleteService()">ğŸ—‘ï¸ åˆªé™¤æœå‹™</button>
              <button type="submit" class="btn btn-primary">ğŸ’¾ æ›´æ–°æœå‹™</button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>

  <script src="/admin/js/admin.js"></script>
  <script>
    let currentServiceId = null;

    // Handle day checkbox changes
    document.addEventListener('DOMContentLoaded', () => {
      // Get service ID from URL
      const pathParts = window.location.pathname.split('/');
      currentServiceId = pathParts[pathParts.length - 1];

      if (!currentServiceId || currentServiceId === 'edit') {
        alert('ç„¡æ•ˆçš„æœå‹™ ID');
        window.location.href = '/admin/services';
        return;
      }

      // Load service data
      loadServiceData();

      const dayCheckboxes = document.querySelectorAll('.day-checkbox');

      dayCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const schedule = this.closest('.day-schedule');
          const timeInputs = schedule.querySelectorAll('input[type="time"]');

          timeInputs.forEach(input => {
            input.disabled = !this.checked;
          });
        });
      });

      // Form submission
      document.getElementById('serviceForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await updateService();
      });

      // Initialize admin dashboard
      if (typeof AdminDashboard !== 'undefined') {
        AdminDashboard.init();
      }
    });

    // Load service data
    async function loadServiceData() {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`/services/${currentServiceId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          if (response.status === 404) {
            alert('æœå‹™ä¸å­˜åœ¨');
            window.location.href = '/admin/services';
            return;
          }
          throw new Error('Failed to load service');
        }

        const result = await response.json();
        if (result.success && result.data) {
          populateForm(result.data);
          document.getElementById('loadingIndicator').style.display = 'none';
          document.getElementById('serviceFormCard').style.display = 'block';
        } else {
          throw new Error('Invalid service data');
        }
      } catch (error) {
        console.error('Error loading service:', error);
        alert('è¼‰å…¥æœå‹™è³‡æ–™å¤±æ•—: ' + error.message);
        window.location.href = '/admin/services';
      }
    }

    // Populate form with service data
    function populateForm(service) {
      document.getElementById('serviceName').value = service.name || '';
      document.getElementById('serviceCategory').value = service.category || 'other';
      document.getElementById('serviceDescription').value = service.description || '';
      document.getElementById('servicePrice').value = service.price || 0;
      document.getElementById('serviceDuration').value = service.duration || 60;
      document.getElementById('serviceLocation').value = service.location || 'office';
      document.getElementById('maxBookings').value = service.maxBookingsPerDay || 5;
      document.getElementById('advanceBooking').value = service.advanceBookingDays || 1;
      document.getElementById('serviceStatus').value = service.isActive ? 'true' : 'false';

      // Service info
      document.getElementById('serviceId').textContent = service.id;
      document.getElementById('createdAt').textContent = new Date(service.createdAt).toLocaleString('zh-TW');
      document.getElementById('updatedAt').textContent = new Date(service.updatedAt).toLocaleString('zh-TW');

      // Schedule data
      if (service.schedule) {
        const daySchedules = document.querySelectorAll('.day-schedule');
        daySchedules.forEach(schedule => {
          const day = schedule.dataset.day;
          const dayData = service.schedule[day];

          if (dayData) {
            const checkbox = schedule.querySelector('.day-checkbox');
            const startTime = schedule.querySelector('.time-start');
            const endTime = schedule.querySelector('.time-end');

            checkbox.checked = dayData.enabled || false;
            if (dayData.enabled) {
              startTime.value = dayData.startTime || '09:00';
              endTime.value = dayData.endTime || '17:00';
              startTime.disabled = false;
              endTime.disabled = false;
            } else {
              startTime.disabled = true;
              endTime.disabled = true;
            }
          }
        });
      }
    }

    // Update service
    async function updateService() {
      try {
        // Collect form data
        const serviceData = {
          name: document.getElementById('serviceName').value,
          category: document.getElementById('serviceCategory').value,
          description: document.getElementById('serviceDescription').value,
          price: parseFloat(document.getElementById('servicePrice').value),
          duration: parseInt(document.getElementById('serviceDuration').value),
          location: document.getElementById('serviceLocation').value,
          maxBookingsPerDay: parseInt(document.getElementById('maxBookings').value),
          advanceBookingDays: parseInt(document.getElementById('advanceBooking').value),
          isActive: document.getElementById('serviceStatus').value === 'true',
          schedule: collectScheduleData()
        };

        // Validate required fields
        if (!serviceData.name || !serviceData.price || !serviceData.duration) {
          alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
          return;
        }

        const token = localStorage.getItem('adminToken');
        const response = await fetch(`/services/${currentServiceId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(serviceData)
        });

        if (!response.ok) {
          throw new Error('Failed to update service');
        }

        const result = await response.json();
        if (result.success) {
          alert('æœå‹™å·²æˆåŠŸæ›´æ–°ï¼');
          window.location.href = '/admin/services';
        } else {
          throw new Error(result.error?.message || 'Unknown error');
        }
      } catch (error) {
        console.error('Error updating service:', error);
        alert('æ›´æ–°æœå‹™å¤±æ•—: ' + error.message);
      }
    }

    // Delete service
    async function deleteService() {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æœå‹™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
        return;
      }

      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`/services/${currentServiceId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to delete service');
        }

        const result = await response.json();
        if (result.success) {
          alert('æœå‹™å·²æˆåŠŸåˆªé™¤ï¼');
          window.location.href = '/admin/services';
        } else {
          throw new Error(result.error?.message || 'Unknown error');
        }
      } catch (error) {
        console.error('Error deleting service:', error);
        alert('åˆªé™¤æœå‹™å¤±æ•—: ' + error.message);
      }
    }

    // Collect schedule data
    function collectScheduleData() {
      const schedules = {};
      const daySchedules = document.querySelectorAll('.day-schedule');

      daySchedules.forEach(schedule => {
        const day = schedule.dataset.day;
        const checkbox = schedule.querySelector('.day-checkbox');
        const startTime = schedule.querySelector('.time-start');
        const endTime = schedule.querySelector('.time-end');

        if (checkbox.checked) {
          schedules[day] = {
            enabled: true,
            startTime: startTime.value,
            endTime: endTime.value
          };
        } else {
          schedules[day] = {
            enabled: false
          };
        }
      });

      return schedules;
    }
  </script>

  <style>
    .loading-overlay {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f4f6;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #f9fafb;
    }

    .form-section h3 {
      margin-top: 0;
      margin-bottom: 20px;
      color: #374151;
    }

    .form-info {
      margin: 30px 0;
      padding: 20px;
      background: #f3f4f6;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
    }

    .form-info p {
      margin: 5px 0;
      color: #6b7280;
    }

    .form-info strong {
      color: #374151;
      margin-right: 10px;
    }

    .time-slots {
      display: grid;
      gap: 15px;
    }

    .day-schedule {
      display: grid;
      grid-template-columns: 100px 80px auto 80px;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: white;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }

    .day-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      cursor: pointer;
    }

    .day-checkbox {
      margin: 0;
    }

    .time-start,
    .time-end {
      padding: 8px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 14px;
    }

    .time-start:disabled,
    .time-end:disabled {
      background: #f3f4f6;
      color: #9ca3af;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #374151;
    }

    .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }

    .form-control:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px #3b82f6;
    }

    textarea.form-control {
      resize: vertical;
      min-height: 100px;
    }

    .btn-danger {
      background-color: #ef4444;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.2s;
    }

    .btn-danger:hover {
      background-color: #dc2626;
    }
  </style>
</body>
</html>