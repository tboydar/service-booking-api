<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>日誌管理 - Service Booking API</title>
  <link rel="stylesheet" href="/admin/css/admin.css">
</head>
<body>
  <div class="admin-wrapper">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <h3>🎯 管理後台</h3>
      </div>
      <ul class="sidebar-menu">
        <li><a href="/admin/dashboard">📊 儀表板</a></li>
        <li><a href="/admin/system">💻 系統監控</a></li>
        <li><a href="/admin/logs" class="active">📝 日誌管理</a></li>
        <li><a href="/admin/scheduler">⏰ 排程管理</a></li>
        <li><a href="/admin/k6-test">🚀 K6 效能測試</a></li>
        <li><a href="/admin/services">📦 服務管理</a></li>
        <li><a href="/admin/users">👥 用戶管理</a></li>
        <li><a href="#" id="logoutBtn">🚪 登出</a></li>
      </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="header">
        <h1>📝 日誌管理</h1>
        <div class="header-actions">
          <button id="refreshLogs" class="btn btn-secondary">🔄 重新整理</button>
          <button id="clearLogs" class="btn btn-danger">🗑️ 清除日誌</button>
          <button id="exportLogs" class="btn btn-primary">📥 匯出日誌</button>
        </div>
      </div>

      <!-- Filter Controls -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">🔍 篩選條件</h2>
        </div>
        <div class="card-body">
          <div class="filter-grid">
            <div class="form-group">
              <label for="levelFilter">日誌等級</label>
              <select id="levelFilter" class="form-control">
                <option value="">全部</option>
                <option value="error">錯誤 (Error)</option>
                <option value="warn">警告 (Warn)</option>
                <option value="info">資訊 (Info)</option>
                <option value="debug">除錯 (Debug)</option>
              </select>
            </div>
            <div class="form-group">
              <label for="dateFilter">日期範圍</label>
              <select id="dateFilter" class="form-control">
                <option value="today">今天</option>
                <option value="yesterday">昨天</option>
                <option value="week">最近 7 天</option>
                <option value="month">最近 30 天</option>
                <option value="all" selected>全部</option>
              </select>
            </div>
            <div class="form-group">
              <label for="searchFilter">搜尋關鍵字</label>
              <input type="text" id="searchFilter" class="form-control" placeholder="輸入關鍵字...">
            </div>
            <div class="form-group">
              <label>&nbsp;</label>
              <button id="applyFilter" class="btn btn-primary">套用篩選</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Log Statistics -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>📊 總日誌數</h3>
          <p class="stat-value" id="totalLogs">0</p>
        </div>
        <div class="stat-card error">
          <h3>❌ 錯誤</h3>
          <p class="stat-value" id="errorCount">0</p>
        </div>
        <div class="stat-card warning">
          <h3>⚠️ 警告</h3>
          <p class="stat-value" id="warnCount">0</p>
        </div>
        <div class="stat-card info">
          <h3>ℹ️ 資訊</h3>
          <p class="stat-value" id="infoCount">0</p>
        </div>
      </div>

      <!-- Logs Table -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">📜 日誌記錄</h2>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>時間</th>
                  <th>等級</th>
                  <th>訊息</th>
                  <th>詳細資訊</th>
                </tr>
              </thead>
              <tbody id="logsTableBody">
                <tr>
                  <td colspan="4" class="text-center">載入日誌中...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="pagination">
            <button id="prevPage" class="btn btn-secondary" disabled>上一頁</button>
            <span id="pageInfo">第 1 頁，共 1 頁</span>
            <button id="nextPage" class="btn btn-secondary">下一頁</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="/admin/js/admin.js"></script>
  <script>
    let currentPage = 1;
    let totalPages = 1;
    let logs = [];
    let filteredLogs = [];

    // Load logs
    async function loadLogs() {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch('/admin/api/logs', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load logs');
        }

        const result = await response.json();
        if (result.success) {
          logs = result.data.logs || [];
          applyFilters();
          updateStatistics();
        }
      } catch (error) {
        console.error('Error loading logs:', error);
        showError('無法載入日誌');
      }
    }

    // Apply filters
    function applyFilters() {
      const level = document.getElementById('levelFilter').value;
      const dateRange = document.getElementById('dateFilter').value;
      const searchTerm = document.getElementById('searchFilter').value.toLowerCase();

      filteredLogs = logs.filter(log => {
        // Level filter
        if (level && log.level !== level) return false;

        // Date filter
        if (dateRange !== 'all') {
          const logDate = new Date(log.timestamp);
          const now = new Date();
          const dayMs = 24 * 60 * 60 * 1000;

          switch (dateRange) {
            case 'today':
              if (logDate.toDateString() !== now.toDateString()) return false;
              break;
            case 'yesterday':
              const yesterday = new Date(now - dayMs);
              if (logDate.toDateString() !== yesterday.toDateString()) return false;
              break;
            case 'week':
              if (now - logDate > 7 * dayMs) return false;
              break;
            case 'month':
              if (now - logDate > 30 * dayMs) return false;
              break;
          }
        }

        // Search filter
        if (searchTerm) {
          const searchIn = `${log.message} ${JSON.stringify(log.meta || {})}`.toLowerCase();
          if (!searchIn.includes(searchTerm)) return false;
        }

        return true;
      });

      currentPage = 1;
      displayLogs();
    }

    // Display logs
    function displayLogs() {
      const pageSize = 20;
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageLogs = filteredLogs.slice(start, end);

      const tbody = document.getElementById('logsTableBody');

      if (pageLogs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">沒有找到日誌記錄</td></tr>';
        return;
      }

      tbody.innerHTML = pageLogs.map(log => `
        <tr class="log-${log.level}">
          <td>${new Date(log.timestamp).toLocaleString('zh-TW')}</td>
          <td><span class="badge badge-${log.level}">${getLevelLabel(log.level)}</span></td>
          <td>${escapeHtml(log.message)}</td>
          <td>
            ${log.meta ? `<button class="btn btn-sm" onclick="showLogDetails('${escapeHtml(JSON.stringify(log.meta))}')">查看</button>` : '-'}
          </td>
        </tr>
      `).join('');

      // Update pagination
      totalPages = Math.ceil(filteredLogs.length / pageSize);
      document.getElementById('pageInfo').textContent = `第 ${currentPage} 頁，共 ${totalPages} 頁`;
      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = currentPage === totalPages;
    }

    // Update statistics
    function updateStatistics() {
      const stats = {
        total: filteredLogs.length,
        error: filteredLogs.filter(l => l.level === 'error').length,
        warn: filteredLogs.filter(l => l.level === 'warn').length,
        info: filteredLogs.filter(l => l.level === 'info').length
      };

      document.getElementById('totalLogs').textContent = stats.total;
      document.getElementById('errorCount').textContent = stats.error;
      document.getElementById('warnCount').textContent = stats.warn;
      document.getElementById('infoCount').textContent = stats.info;
    }

    // Get level label
    function getLevelLabel(level) {
      const labels = {
        error: '錯誤',
        warn: '警告',
        info: '資訊',
        debug: '除錯'
      };
      return labels[level] || level;
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Show log details
    function showLogDetails(metaJson) {
      try {
        const meta = JSON.parse(metaJson);
        alert(JSON.stringify(meta, null, 2));
      } catch (e) {
        console.error('Error showing log details:', e);
      }
    }

    // Export logs
    async function exportLogs() {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch('/admin/api/logs/export', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to export logs');
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `logs-${new Date().toISOString()}.json`;
        a.click();
        window.URL.revokeObjectURL(url);
      } catch (error) {
        console.error('Error exporting logs:', error);
        showError('無法匯出日誌');
      }
    }

    // Clear logs
    function clearLogs() {
      if (confirm('確定要清除所有日誌嗎？此操作無法復原。')) {
        // In a real implementation, this would call an API to clear logs
        logs = [];
        filteredLogs = [];
        displayLogs();
        updateStatistics();
        alert('日誌已清除');
      }
    }

    // Show error message
    function showError(message) {
      alert(message);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadLogs();

      // Event listeners
      document.getElementById('refreshLogs').addEventListener('click', loadLogs);
      document.getElementById('exportLogs').addEventListener('click', exportLogs);
      document.getElementById('clearLogs').addEventListener('click', clearLogs);
      document.getElementById('applyFilter').addEventListener('click', applyFilters);
      document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          displayLogs();
        }
      });
      document.getElementById('nextPage').addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          displayLogs();
        }
      });

      // Auto refresh every 10 seconds
      setInterval(loadLogs, 10000);

      // Initialize admin dashboard
      if (typeof AdminDashboard !== 'undefined') {
        AdminDashboard.init();
      }
    });
  </script>

  <style>
    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      align-items: end;
    }

    .table-container {
      overflow-x: auto;
      margin-bottom: 20px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    .data-table th {
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
    }

    .log-error {
      background: #fee2e2;
    }

    .log-warn {
      background: #fef3c7;
    }

    .log-info {
      background: #dbeafe;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-error {
      background: #ef4444;
      color: white;
    }

    .badge-warn {
      background: #f59e0b;
      color: white;
    }

    .badge-info {
      background: #3b82f6;
      color: white;
    }

    .badge-debug {
      background: #6b7280;
      color: white;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-top: 20px;
    }

    .stat-card.error {
      background: #fee2e2;
    }

    .stat-card.warning {
      background: #fef3c7;
    }

    .stat-card.info {
      background: #dbeafe;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .text-center {
      text-align: center;
    }
  </style>
</body>
</html>