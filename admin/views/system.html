<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç³»çµ±ç›£æ§ - Service Booking API</title>
  <link rel="stylesheet" href="/admin/css/admin.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="admin-wrapper">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <h3>ğŸ¯ ç®¡ç†å¾Œå°</h3>
      </div>
      <ul class="sidebar-menu">
        <li><a href="/admin/dashboard">ğŸ“Š å„€è¡¨æ¿</a></li>
        <li><a href="/admin/system" class="active">ğŸ’» ç³»çµ±ç›£æ§</a></li>
        <li><a href="/admin/logs">ğŸ“ æ—¥èªŒç®¡ç†</a></li>
        <li><a href="/admin/scheduler">â° æ’ç¨‹ç®¡ç†</a></li>
        <li><a href="/admin/k6-test">ğŸš€ K6 æ•ˆèƒ½æ¸¬è©¦</a></li>
        <li><a href="/admin/services">ğŸ“¦ æœå‹™ç®¡ç†</a></li>
        <li><a href="/admin/users">ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</a></li>
        <li><a href="#" id="logoutBtn">ğŸšª ç™»å‡º</a></li>
      </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="header">
        <h1>ğŸ’» ç³»çµ±ç›£æ§</h1>
        <button id="refreshSystem" class="btn btn-primary">ğŸ”„ é‡æ–°æ•´ç†</button>
      </div>

      <!-- System Overview -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>ğŸ–¥ï¸ ä¸»æ©Ÿåç¨±</h3>
          <p class="stat-value" id="hostname">è¼‰å…¥ä¸­...</p>
        </div>
        <div class="stat-card">
          <h3>ğŸŒ IP ä½å€</h3>
          <p class="stat-value" id="ipAddress">è¼‰å…¥ä¸­...</p>
        </div>
        <div class="stat-card">
          <h3>â±ï¸ ç³»çµ±é‹è¡Œæ™‚é–“</h3>
          <p class="stat-value" id="uptime">è¼‰å…¥ä¸­...</p>
        </div>
        <div class="stat-card">
          <h3>ğŸ”§ å¹³å°</h3>
          <p class="stat-value" id="platform">è¼‰å…¥ä¸­...</p>
        </div>
      </div>

      <!-- Resource Usage Charts -->
      <div class="charts-grid">
        <!-- CPU Usage -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">ğŸ¯ CPU ä½¿ç”¨ç‡</h2>
          </div>
          <div class="card-body">
            <canvas id="cpuChart"></canvas>
            <div class="metric-details">
              <p>ç•¶å‰ä½¿ç”¨ç‡: <span id="cpuUsage">0</span>%</p>
              <p>æ ¸å¿ƒæ•¸: <span id="cpuCores">0</span></p>
              <p>å‹è™Ÿ: <span id="cpuModel">è¼‰å…¥ä¸­...</span></p>
            </div>
          </div>
        </div>

        <!-- Memory Usage -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">ğŸ’¾ è¨˜æ†¶é«”ä½¿ç”¨ç‡</h2>
          </div>
          <div class="card-body">
            <canvas id="memoryChart"></canvas>
            <div class="metric-details">
              <p>å·²ä½¿ç”¨: <span id="memUsed">0</span> GB / <span id="memTotal">0</span> GB</p>
              <p>ä½¿ç”¨ç‡: <span id="memUsage">0</span>%</p>
              <p>å¯ç”¨: <span id="memAvailable">0</span> GB</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Disk Usage -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ğŸ’½ ç£ç¢Ÿä½¿ç”¨ç‹€æ³</h2>
        </div>
        <div class="card-body">
          <div id="diskContainer">
            <p>è¼‰å…¥ç£ç¢Ÿè³‡è¨Šä¸­...</p>
          </div>
        </div>
      </div>

      <!-- Network Info -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ğŸŒ ç¶²è·¯è³‡è¨Š</h2>
        </div>
        <div class="card-body">
          <div id="networkContainer">
            <p>è¼‰å…¥ç¶²è·¯è³‡è¨Šä¸­...</p>
          </div>
        </div>
      </div>

      <!-- Database Info -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ğŸ—„ï¸ è³‡æ–™åº«è³‡è¨Š</h2>
        </div>
        <div class="card-body">
          <div class="metric-details">
            <p>é¡å‹: SQLite</p>
            <p>æª”æ¡ˆä½ç½®: <span id="dbPath">./database.sqlite</span></p>
            <p>å¤§å°: <span id="dbSize">è¼‰å…¥ä¸­...</span></p>
            <p>è¡¨æ ¼æ•¸: <span id="dbTables">è¼‰å…¥ä¸­...</span></p>
            <p>ç‰ˆæœ¬: <span id="dbVersion">è¼‰å…¥ä¸­...</span></p>
          </div>
        </div>
      </div>

      <!-- Process Info -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">âš™ï¸ è™•ç†ç¨‹åºè³‡è¨Š</h2>
        </div>
        <div class="card-body">
          <div class="metric-details">
            <p>Node.js ç‰ˆæœ¬: <span id="nodeVersion">è¼‰å…¥ä¸­...</span></p>
            <p>NPM ç‰ˆæœ¬: <span id="npmVersion">è¼‰å…¥ä¸­...</span></p>
            <p>è™•ç†ç¨‹åº ID: <span id="processId">è¼‰å…¥ä¸­...</span></p>
            <p>è¨˜æ†¶é«”ä½¿ç”¨: <span id="processMemory">è¼‰å…¥ä¸­...</span></p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="/admin/js/admin.js"></script>
  <script>
    // CPU and Memory Charts
    let cpuChart, memoryChart;
    let cpuData = [];
    let memoryData = [];
    const maxDataPoints = 20;

    // Initialize Charts
    function initCharts() {
      // CPU Chart
      const cpuCtx = document.getElementById('cpuChart').getContext('2d');
      cpuChart = new Chart(cpuCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'CPU ä½¿ç”¨ç‡ (%)',
            data: cpuData,
            borderColor: 'rgb(37, 99, 235)',
            backgroundColor: 'rgba(37, 99, 235, 0.1)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });

      // Memory Chart
      const memCtx = document.getElementById('memoryChart').getContext('2d');
      memoryChart = new Chart(memCtx, {
        type: 'doughnut',
        data: {
          labels: ['å·²ä½¿ç”¨', 'å¯ç”¨'],
          datasets: [{
            data: [0, 100],
            backgroundColor: [
              'rgb(239, 68, 68)',
              'rgb(34, 197, 94)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    // Load System Info
    async function loadSystemInfo() {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch('/admin/api/system', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load system info');
        }

        const result = await response.json();
        if (result.success) {
          updateSystemInfo(result.data);
        }
      } catch (error) {
        console.error('Error loading system info:', error);
      }
    }

    // Update System Info
    function updateSystemInfo(data) {
      // Basic Info
      document.getElementById('hostname').textContent = data.hostname || 'N/A';
      document.getElementById('ipAddress').textContent = data.network?.ip || 'N/A';
      document.getElementById('uptime').textContent = formatUptime(data.uptime);
      document.getElementById('platform').textContent = data.platform || 'N/A';

      // CPU Info
      document.getElementById('cpuUsage').textContent = data.cpu?.usage?.toFixed(1) || '0';
      document.getElementById('cpuCores').textContent = data.cpu?.cores || '0';
      document.getElementById('cpuModel').textContent = data.cpu?.model || 'N/A';

      // Update CPU Chart
      const time = new Date().toLocaleTimeString('zh-TW');
      cpuData.push(data.cpu?.usage || 0);
      if (cpuData.length > maxDataPoints) {
        cpuData.shift();
      }
      cpuChart.data.labels.push(time);
      if (cpuChart.data.labels.length > maxDataPoints) {
        cpuChart.data.labels.shift();
      }
      cpuChart.data.datasets[0].data = cpuData;
      cpuChart.update();

      // Memory Info - API å·²ç¶“è¿”å› GB å–®ä½ï¼Œä¸éœ€è¦å†è½‰æ›
      const memUsed = (data.memory?.used || 0).toFixed(2);
      const memTotal = (data.memory?.total || 0).toFixed(2);
      const memAvailable = (data.memory?.free || 0).toFixed(2);  // ä½¿ç”¨ free è€Œé available
      const memUsage = data.memory?.total > 0 ? ((data.memory?.used / data.memory?.total) * 100).toFixed(1) : '0';

      document.getElementById('memUsed').textContent = memUsed;
      document.getElementById('memTotal').textContent = memTotal;
      document.getElementById('memUsage').textContent = memUsage;
      document.getElementById('memAvailable').textContent = memAvailable;

      // Update Memory Chart
      memoryChart.data.datasets[0].data = [
        parseFloat(memUsage),
        100 - parseFloat(memUsage)
      ];
      memoryChart.update();

      // Disk Info - API è¿”å›çš„æ˜¯å–®å€‹ç£ç¢Ÿç‰©ä»¶ï¼Œå·²ç¶“æ˜¯ GB å–®ä½
      if (data.disk) {
        const diskUsagePercent = data.disk.total > 0 ? (data.disk.used / data.disk.total * 100) : 0;
        const diskHtml = `
          <div class="disk-item">
            <h4>ä¸»è¦ç£ç¢Ÿ</h4>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${diskUsagePercent.toFixed(1)}%"></div>
            </div>
            <p>å·²ä½¿ç”¨: ${(data.disk.used || 0).toFixed(2)} GB / ${(data.disk.total || 0).toFixed(2)} GB (${diskUsagePercent.toFixed(1)}%)</p>
            <p>å¯ç”¨ç©ºé–“: ${(data.disk.free || 0).toFixed(2)} GB</p>
          </div>
        `;
        document.getElementById('diskContainer').innerHTML = diskHtml;
      }

      // Network Info
      if (data.network && data.network.interfaces && data.network.interfaces.length > 0) {
        const networkHtml = data.network.interfaces.map(net => `
          <div class="network-item">
            <h4>${net.name}</h4>
            <p>IPv4: ${net.ip4 || 'N/A'}</p>
            <p>IPv6: ${net.ip6 || 'N/A'}</p>
            <p>MAC: ${net.mac || 'N/A'}</p>
          </div>
        `).join('');
        document.getElementById('networkContainer').innerHTML = networkHtml;
      }

      // Database Info
      document.getElementById('dbSize').textContent = data.database?.size || 'N/A';
      document.getElementById('dbTables').textContent = data.database?.tables || 'N/A';
      document.getElementById('dbVersion').textContent = data.database?.version || 'N/A';

      // Process Info
      document.getElementById('nodeVersion').textContent = data.nodeVersion || 'N/A';
      document.getElementById('npmVersion').textContent = data.npmVersion || 'N/A';
      document.getElementById('processId').textContent = data.pid || 'N/A';
      document.getElementById('processMemory').textContent =
        data.processMemory ? `${(data.processMemory.rss / (1024 * 1024)).toFixed(2)} MB` : 'N/A';
    }

    // Format uptime
    function formatUptime(seconds) {
      const days = Math.floor(seconds / 86400);
      const hours = Math.floor((seconds % 86400) / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      return `${days}å¤© ${hours}å°æ™‚ ${minutes}åˆ†é˜`;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initCharts();
      loadSystemInfo();

      // Auto refresh every 5 seconds
      setInterval(loadSystemInfo, 5000);

      // Refresh button
      document.getElementById('refreshSystem').addEventListener('click', loadSystemInfo);

      // Initialize admin dashboard
      if (typeof AdminDashboard !== 'undefined') {
        AdminDashboard.init();
      }
    });
  </script>

  <style>
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .metric-details {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }

    .metric-details p {
      margin: 8px 0;
      color: #6b7280;
    }

    .metric-details span {
      color: #1f2937;
      font-weight: 600;
    }

    .disk-item, .network-item {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .disk-item:last-child, .network-item:last-child {
      border-bottom: none;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #2563eb);
      transition: width 0.3s ease;
    }

    #cpuChart, #memoryChart {
      max-height: 200px;
    }
  </style>
</body>
</html>