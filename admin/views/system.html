<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>系統監控 - Service Booking API</title>
  <link rel="stylesheet" href="/admin/css/admin.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="admin-wrapper">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <h3>🎯 管理後台</h3>
      </div>
      <ul class="sidebar-menu">
        <li><a href="/admin/dashboard">📊 儀表板</a></li>
        <li><a href="/admin/system" class="active">💻 系統監控</a></li>
        <li><a href="/admin/logs">📝 日誌管理</a></li>
        <li><a href="/admin/scheduler">⏰ 排程管理</a></li>
        <li><a href="/admin/k6-test">🚀 K6 效能測試</a></li>
        <li><a href="/admin/services">📦 服務管理</a></li>
        <li><a href="/admin/users">👥 用戶管理</a></li>
        <li><a href="#" id="logoutBtn">🚪 登出</a></li>
      </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="header">
        <h1>💻 系統監控</h1>
        <button id="refreshSystem" class="btn btn-primary">🔄 重新整理</button>
      </div>

      <!-- System Overview -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>🖥️ 主機名稱</h3>
          <p class="stat-value" id="hostname">載入中...</p>
        </div>
        <div class="stat-card">
          <h3>🌐 IP 位址</h3>
          <p class="stat-value" id="ipAddress">載入中...</p>
        </div>
        <div class="stat-card">
          <h3>⏱️ 系統運行時間</h3>
          <p class="stat-value" id="uptime">載入中...</p>
        </div>
        <div class="stat-card">
          <h3>🔧 平台</h3>
          <p class="stat-value" id="platform">載入中...</p>
        </div>
      </div>

      <!-- Resource Usage Charts -->
      <div class="charts-grid">
        <!-- CPU Usage -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">🎯 CPU 使用率</h2>
          </div>
          <div class="card-body">
            <canvas id="cpuChart"></canvas>
            <div class="metric-details">
              <p>當前使用率: <span id="cpuUsage">0</span>%</p>
              <p>核心數: <span id="cpuCores">0</span></p>
              <p>型號: <span id="cpuModel">載入中...</span></p>
            </div>
          </div>
        </div>

        <!-- Memory Usage -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">💾 記憶體使用率</h2>
          </div>
          <div class="card-body">
            <canvas id="memoryChart"></canvas>
            <div class="metric-details">
              <p>已使用: <span id="memUsed">0</span> GB / <span id="memTotal">0</span> GB</p>
              <p>使用率: <span id="memUsage">0</span>%</p>
              <p>可用: <span id="memAvailable">0</span> GB</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Disk Usage -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">💽 磁碟使用狀況</h2>
        </div>
        <div class="card-body">
          <div id="diskContainer">
            <p>載入磁碟資訊中...</p>
          </div>
        </div>
      </div>

      <!-- Network Info -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">🌍 網路資訊</h2>
        </div>
        <div class="card-body">
          <div id="networkContainer">
            <p>載入網路資訊中...</p>
          </div>
        </div>
      </div>

      <!-- Database Info -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">🗄️ 資料庫資訊</h2>
        </div>
        <div class="card-body">
          <div class="metric-details">
            <p>類型: SQLite</p>
            <p>檔案位置: <span id="dbPath">./database.sqlite</span></p>
            <p>大小: <span id="dbSize">載入中...</span></p>
            <p>表格數: <span id="dbTables">載入中...</span></p>
            <p>版本: <span id="dbVersion">載入中...</span></p>
          </div>
        </div>
      </div>

      <!-- Process Info -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">⚙️ 處理程序資訊</h2>
        </div>
        <div class="card-body">
          <div class="metric-details">
            <p>Node.js 版本: <span id="nodeVersion">載入中...</span></p>
            <p>NPM 版本: <span id="npmVersion">載入中...</span></p>
            <p>處理程序 ID: <span id="processId">載入中...</span></p>
            <p>記憶體使用: <span id="processMemory">載入中...</span></p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="/admin/js/admin.js"></script>
  <script>
    // CPU and Memory Charts
    let cpuChart, memoryChart;
    let cpuData = [];
    let memoryData = [];
    const maxDataPoints = 20;

    // Initialize Charts
    function initCharts() {
      // CPU Chart
      const cpuCtx = document.getElementById('cpuChart').getContext('2d');
      cpuChart = new Chart(cpuCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'CPU 使用率 (%)',
            data: cpuData,
            borderColor: 'rgb(37, 99, 235)',
            backgroundColor: 'rgba(37, 99, 235, 0.1)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });

      // Memory Chart
      const memCtx = document.getElementById('memoryChart').getContext('2d');
      memoryChart = new Chart(memCtx, {
        type: 'doughnut',
        data: {
          labels: ['已使用', '可用'],
          datasets: [{
            data: [0, 100],
            backgroundColor: [
              'rgb(239, 68, 68)',
              'rgb(34, 197, 94)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    // Load System Info
    async function loadSystemInfo() {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch('/admin/api/system', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load system info');
        }

        const result = await response.json();
        if (result.success) {
          updateSystemInfo(result.data);
        }
      } catch (error) {
        console.error('Error loading system info:', error);
      }
    }

    // Update System Info
    function updateSystemInfo(data) {
      // Basic Info
      document.getElementById('hostname').textContent = data.hostname || 'N/A';
      document.getElementById('ipAddress').textContent = data.network?.ip || 'N/A';
      document.getElementById('uptime').textContent = formatUptime(data.uptime);
      document.getElementById('platform').textContent = data.platform || 'N/A';

      // CPU Info
      document.getElementById('cpuUsage').textContent = data.cpu?.usage?.toFixed(1) || '0';
      document.getElementById('cpuCores').textContent = data.cpu?.cores || '0';
      document.getElementById('cpuModel').textContent = data.cpu?.model || 'N/A';

      // Update CPU Chart
      const time = new Date().toLocaleTimeString('zh-TW');
      cpuData.push(data.cpu?.usage || 0);
      if (cpuData.length > maxDataPoints) {
        cpuData.shift();
      }
      cpuChart.data.labels.push(time);
      if (cpuChart.data.labels.length > maxDataPoints) {
        cpuChart.data.labels.shift();
      }
      cpuChart.data.datasets[0].data = cpuData;
      cpuChart.update();

      // Memory Info - API 已經返回 GB 單位，不需要再轉換
      const memUsed = (data.memory?.used || 0).toFixed(2);
      const memTotal = (data.memory?.total || 0).toFixed(2);
      const memAvailable = (data.memory?.free || 0).toFixed(2);  // 使用 free 而非 available
      const memUsage = data.memory?.total > 0 ? ((data.memory?.used / data.memory?.total) * 100).toFixed(1) : '0';

      document.getElementById('memUsed').textContent = memUsed;
      document.getElementById('memTotal').textContent = memTotal;
      document.getElementById('memUsage').textContent = memUsage;
      document.getElementById('memAvailable').textContent = memAvailable;

      // Update Memory Chart
      memoryChart.data.datasets[0].data = [
        parseFloat(memUsage),
        100 - parseFloat(memUsage)
      ];
      memoryChart.update();

      // Disk Info - API 返回的是單個磁碟物件，已經是 GB 單位
      if (data.disk) {
        const diskUsagePercent = data.disk.total > 0 ? (data.disk.used / data.disk.total * 100) : 0;
        const diskHtml = `
          <div class="disk-item">
            <h4>主要磁碟</h4>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${diskUsagePercent.toFixed(1)}%"></div>
            </div>
            <p>已使用: ${(data.disk.used || 0).toFixed(2)} GB / ${(data.disk.total || 0).toFixed(2)} GB (${diskUsagePercent.toFixed(1)}%)</p>
            <p>可用空間: ${(data.disk.free || 0).toFixed(2)} GB</p>
          </div>
        `;
        document.getElementById('diskContainer').innerHTML = diskHtml;
      }

      // Network Info
      if (data.network && data.network.interfaces && data.network.interfaces.length > 0) {
        const networkHtml = data.network.interfaces.map(net => `
          <div class="network-item">
            <h4>${net.name}</h4>
            <p>IPv4: ${net.ip4 || 'N/A'}</p>
            <p>IPv6: ${net.ip6 || 'N/A'}</p>
            <p>MAC: ${net.mac || 'N/A'}</p>
          </div>
        `).join('');
        document.getElementById('networkContainer').innerHTML = networkHtml;
      }

      // Database Info
      document.getElementById('dbSize').textContent = data.database?.size || 'N/A';
      document.getElementById('dbTables').textContent = data.database?.tables || 'N/A';
      document.getElementById('dbVersion').textContent = data.database?.version || 'N/A';

      // Process Info
      document.getElementById('nodeVersion').textContent = data.nodeVersion || 'N/A';
      document.getElementById('npmVersion').textContent = data.npmVersion || 'N/A';
      document.getElementById('processId').textContent = data.pid || 'N/A';
      document.getElementById('processMemory').textContent =
        data.processMemory ? `${(data.processMemory.rss / (1024 * 1024)).toFixed(2)} MB` : 'N/A';
    }

    // Format uptime
    function formatUptime(seconds) {
      const days = Math.floor(seconds / 86400);
      const hours = Math.floor((seconds % 86400) / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      return `${days}天 ${hours}小時 ${minutes}分鐘`;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initCharts();
      loadSystemInfo();

      // Auto refresh every 5 seconds
      setInterval(loadSystemInfo, 5000);

      // Refresh button
      document.getElementById('refreshSystem').addEventListener('click', loadSystemInfo);

      // Initialize admin dashboard
      if (typeof AdminDashboard !== 'undefined') {
        AdminDashboard.init();
      }
    });
  </script>

  <style>
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .metric-details {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }

    .metric-details p {
      margin: 8px 0;
      color: #6b7280;
    }

    .metric-details span {
      color: #1f2937;
      font-weight: 600;
    }

    .disk-item, .network-item {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .disk-item:last-child, .network-item:last-child {
      border-bottom: none;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #2563eb);
      transition: width 0.3s ease;
    }

    #cpuChart, #memoryChart {
      max-height: 200px;
    }
  </style>
</body>
</html>