<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>K6 效能測試 - Service Booking API</title>
  <link rel="stylesheet" href="/admin/css/admin.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="admin-wrapper">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <h3>🎯 管理後台</h3>
      </div>
      <ul class="sidebar-menu">
        <li><a href="/admin/dashboard">📊 儀表板</a></li>
        <li><a href="/admin/system">💻 系統監控</a></li>
        <li><a href="/admin/logs">📝 日誌管理</a></li>
        <li><a href="/admin/scheduler">⏰ 排程管理</a></li>
        <li><a href="/admin/k6-test" class="active">🚀 K6 效能測試</a></li>
        <li><a href="/admin/services">📦 服務管理</a></li>
        <li><a href="/admin/users">👥 用戶管理</a></li>
        <li><a href="#" id="logoutBtn">🚪 登出</a></li>
      </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="header">
        <h1>🚀 K6 效能測試</h1>
        <button id="refreshReports" class="btn btn-secondary">🔄 重新整理</button>
      </div>

      <!-- Test Plans -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">📋 測試計劃</h2>
        </div>
        <div class="card-body">
          <div class="test-plans-grid">
            <!-- Smoke Test -->
            <div class="test-plan">
              <div class="test-plan-header">
                <h3>💨 煙霧測試 (Smoke Test)</h3>
                <span class="test-badge smoke">基礎測試</span>
              </div>
              <div class="test-plan-body">
                <p><strong>目的：</strong>驗證系統基本功能是否正常運作</p>
                <p><strong>虛擬用戶：</strong>3 個</p>
                <p><strong>測試時間：</strong>1 分鐘</p>
                <p><strong>測試項目：</strong></p>
                <ul>
                  <li>健康檢查 (Health Check)</li>
                  <li>用戶註冊</li>
                  <li>用戶登入</li>
                  <li>取得服務列表</li>
                  <li>建立服務預約</li>
                </ul>
                <p><strong>成功條件：</strong></p>
                <ul>
                  <li>95% 請求響應時間 < 500ms</li>
                  <li>錯誤率 < 10%</li>
                </ul>
              </div>
              <div class="test-plan-footer">
                <button class="btn btn-primary" onclick="runTest('smoke')">🏃‍♂️ 執行測試</button>
                <a href="/k6/scenarios/smoke-test.js" target="_blank" class="btn btn-secondary">📄 查看腳本</a>
              </div>
            </div>

            <!-- Load Test -->
            <div class="test-plan">
              <div class="test-plan-header">
                <h3>📈 負載測試 (Load Test)</h3>
                <span class="test-badge load">負載測試</span>
              </div>
              <div class="test-plan-body">
                <p><strong>目的：</strong>測試系統在預期負載下的性能表現</p>
                <p><strong>虛擬用戶：</strong>10-50 個（階段式增加）</p>
                <p><strong>測試時間：</strong>5 分鐘</p>
                <p><strong>測試階段：</strong></p>
                <ul>
                  <li>階段1：10 用戶 (2分鐘)</li>
                  <li>階段2：25 用戶 (2分鐘)</li>
                  <li>階段3：50 用戶 (1分鐘)</li>
                </ul>
                <p><strong>成功條件：</strong></p>
                <ul>
                  <li>平均響應時間 < 1000ms</li>
                  <li>95% 請求響應時間 < 2000ms</li>
                  <li>錯誤率 < 5%</li>
                </ul>
              </div>
              <div class="test-plan-footer">
                <button class="btn btn-primary" onclick="runTest('load')">🏃‍♂️ 執行測試</button>
                <a href="/k6/scenarios/load-test.js" target="_blank" class="btn btn-secondary">📄 查看腳本</a>
              </div>
            </div>

            <!-- Stress Test -->
            <div class="test-plan">
              <div class="test-plan-header">
                <h3>💪 壓力測試 (Stress Test)</h3>
                <span class="test-badge stress">壓力測試</span>
              </div>
              <div class="test-plan-body">
                <p><strong>目的：</strong>測試系統在極限負載下的表現和恢復能力</p>
                <p><strong>虛擬用戶：</strong>10-100 個（階段式增加）</p>
                <p><strong>測試時間：</strong>10 分鐘</p>
                <p><strong>測試階段：</strong></p>
                <ul>
                  <li>階段1：爬升至 50 用戶 (2分鐘)</li>
                  <li>階段2：維持 50 用戶 (2分鐘)</li>
                  <li>階段3：爬升至 100 用戶 (2分鐘)</li>
                  <li>階段4：維持 100 用戶 (2分鐘)</li>
                  <li>階段5：降回 10 用戶 (2分鐘)</li>
                </ul>
                <p><strong>觀察指標：</strong></p>
                <ul>
                  <li>系統破壞點 (Breaking Point)</li>
                  <li>錯誤率變化</li>
                  <li>響應時間變化</li>
                  <li>系統恢復時間</li>
                </ul>
              </div>
              <div class="test-plan-footer">
                <button class="btn btn-primary" onclick="runTest('stress')">🏃‍♂️ 執行測試</button>
                <a href="/k6/scenarios/stress-test.js" target="_blank" class="btn btn-secondary">📄 查看腳本</a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Test Execution -->
      <div class="card" id="testExecutionCard" style="display: none;">
        <div class="card-header">
          <h2 class="card-title">⚡ 測試執行中</h2>
        </div>
        <div class="card-body">
          <div class="test-progress">
            <div class="progress-info">
              <h3 id="runningTestName">測試名稱</h3>
              <p id="testStatus">準備中...</p>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar">
                <div class="progress-fill" id="testProgress" style="width: 0%"></div>
              </div>
              <span id="progressText">0%</span>
            </div>
            <div class="test-output">
              <h4>測試輸出：</h4>
              <pre id="testOutput">等待測試開始...</pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Test Reports -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">📊 測試報告</h2>
        </div>
        <div class="card-body">
          <div id="reportsContainer">
            <p>載入測試報告中...</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="/admin/js/admin.js"></script>
  <script>
    let currentTest = null;
    let testInterval = null;

    // Load test reports
    async function loadReports() {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch('/admin/api/k6/reports', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load reports');
        }

        const result = await response.json();
        if (result.success) {
          displayReports(result.data.reports || []);
        }
      } catch (error) {
        console.error('Error loading reports:', error);
        document.getElementById('reportsContainer').innerHTML =
          '<p class="error">無法載入測試報告</p>';
      }
    }

    // Display reports
    function displayReports(reports) {
      const container = document.getElementById('reportsContainer');

      if (reports.length === 0) {
        container.innerHTML = '<p class="no-reports">目前沒有測試報告</p>';
        return;
      }

      container.innerHTML = reports.map(report => `
        <div class="report-card">
          <div class="report-header">
            <h3>${report.testType.toUpperCase()} 測試</h3>
            <span class="report-date">${new Date(report.timestamp).toLocaleString('zh-TW')}</span>
          </div>
          <div class="report-metrics">
            <div class="metric">
              <span class="metric-label">總請求數</span>
              <span class="metric-value">${report.metrics.http_reqs || 0}</span>
            </div>
            <div class="metric">
              <span class="metric-label">平均響應時間</span>
              <span class="metric-value">${(report.metrics.http_req_duration_avg || 0).toFixed(2)}ms</span>
            </div>
            <div class="metric">
              <span class="metric-label">95% 響應時間</span>
              <span class="metric-value">${(report.metrics.http_req_duration_p95 || 0).toFixed(2)}ms</span>
            </div>
            <div class="metric">
              <span class="metric-label">錯誤率</span>
              <span class="metric-value ${(report.metrics.http_req_failed_rate || 0) > 0.05 ? 'error' : 'success'}">
                ${((report.metrics.http_req_failed_rate || 0) * 100).toFixed(2)}%
              </span>
            </div>
            <div class="metric">
              <span class="metric-label">測試時長</span>
              <span class="metric-value">${Math.round(report.duration || 0)}s</span>
            </div>
            <div class="metric">
              <span class="metric-label">虛擬用戶</span>
              <span class="metric-value">${report.metrics.vus_max || 0}</span>
            </div>
          </div>
          <div class="report-status">
            <span class="status-badge ${getTestStatus(report.metrics)}">
              ${getTestStatusText(report.metrics)}
            </span>
          </div>
        </div>
      `).join('');
    }

    // Get test status
    function getTestStatus(metrics) {
      const errorRate = metrics.http_req_failed_rate || 0;
      const p95Duration = metrics.http_req_duration_p95 || 0;

      if (errorRate > 0.1 || p95Duration > 5000) return 'failed';
      if (errorRate > 0.05 || p95Duration > 2000) return 'warning';
      return 'passed';
    }

    // Get test status text
    function getTestStatusText(metrics) {
      const status = getTestStatus(metrics);
      const statusMap = {
        'passed': '通過',
        'warning': '警告',
        'failed': '失敗'
      };
      return statusMap[status] || '未知';
    }

    // Run test
    async function runTest(testType) {
      if (currentTest) {
        alert('已有測試在執行中，請等待完成');
        return;
      }

      try {
        currentTest = testType;
        showTestExecution(testType);

        const token = localStorage.getItem('adminToken');
        const response = await fetch('/admin/api/k6/run', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ testType })
        });

        if (!response.ok) {
          throw new Error('Failed to start test');
        }

        const result = await response.json();
        if (result.success) {
          // Start monitoring test progress
          monitorTestProgress(result.data.testId);
        } else {
          throw new Error(result.error?.message || 'Test failed to start');
        }
      } catch (error) {
        console.error('Error running test:', error);
        alert('無法啟動測試: ' + error.message);
        hideTestExecution();
      }
    }

    // Show test execution UI
    function showTestExecution(testType) {
      const testNames = {
        smoke: '煙霧測試',
        load: '負載測試',
        stress: '壓力測試'
      };

      document.getElementById('runningTestName').textContent = testNames[testType] || testType;
      document.getElementById('testStatus').textContent = '測試啟動中...';
      document.getElementById('testProgress').style.width = '0%';
      document.getElementById('progressText').textContent = '0%';
      document.getElementById('testOutput').textContent = '等待測試開始...\n';
      document.getElementById('testExecutionCard').style.display = 'block';
    }

    // Hide test execution UI
    function hideTestExecution() {
      document.getElementById('testExecutionCard').style.display = 'none';
      currentTest = null;
      if (testInterval) {
        clearInterval(testInterval);
        testInterval = null;
      }
    }

    // Monitor test progress (simulated)
    function monitorTestProgress(testId) {
      let progress = 0;
      const duration = getTestDuration(currentTest);
      const updateInterval = 1000; // 1 second
      const totalUpdates = Math.floor(duration / updateInterval);

      testInterval = setInterval(() => {
        progress += 100 / totalUpdates;

        if (progress >= 100) {
          progress = 100;
          document.getElementById('testStatus').textContent = '測試完成';
          document.getElementById('testOutput').textContent += '\n✅ 測試執行完成，正在生成報告...';

          setTimeout(() => {
            hideTestExecution();
            loadReports();
          }, 2000);

          clearInterval(testInterval);
          testInterval = null;
        } else {
          document.getElementById('testStatus').textContent = '測試執行中...';
          document.getElementById('testOutput').textContent += `.`;
        }

        document.getElementById('testProgress').style.width = `${progress}%`;
        document.getElementById('progressText').textContent = `${Math.round(progress)}%`;
      }, updateInterval);
    }

    // Get test duration
    function getTestDuration(testType) {
      const durations = {
        smoke: 60000,  // 1 minute
        load: 300000,  // 5 minutes
        stress: 600000 // 10 minutes
      };
      return durations[testType] || 60000;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadReports();

      // Event listeners
      document.getElementById('refreshReports').addEventListener('click', loadReports);

      // Initialize admin dashboard
      if (typeof AdminDashboard !== 'undefined') {
        AdminDashboard.init();
      }
    });
  </script>

  <style>
    .test-plans-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .test-plan {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      background: white;
    }

    .test-plan-header {
      padding: 20px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .test-plan-body {
      padding: 20px;
    }

    .test-plan-footer {
      padding: 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 10px;
    }

    .test-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .test-badge.smoke {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .test-badge.load {
      background: #fef3c7;
      color: #d97706;
    }

    .test-badge.stress {
      background: #fee2e2;
      color: #dc2626;
    }

    .test-progress {
      text-align: center;
    }

    .progress-info {
      margin-bottom: 20px;
    }

    .progress-bar-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .progress-bar {
      flex: 1;
      height: 20px;
      background: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #2563eb);
      transition: width 0.3s ease;
    }

    .test-output {
      background: #1f2937;
      color: #f3f4f6;
      padding: 20px;
      border-radius: 8px;
      text-align: left;
    }

    .test-output pre {
      margin: 0;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }

    .report-card {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      background: white;
    }

    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e5e7eb;
    }

    .report-date {
      color: #6b7280;
      font-size: 14px;
    }

    .report-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .metric {
      text-align: center;
    }

    .metric-label {
      display: block;
      color: #6b7280;
      font-size: 12px;
      margin-bottom: 5px;
    }

    .metric-value {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
    }

    .metric-value.error {
      color: #dc2626;
    }

    .metric-value.success {
      color: #059669;
    }

    .report-status {
      text-align: center;
    }

    .status-badge {
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-badge.passed {
      background: #d1fae5;
      color: #059669;
    }

    .status-badge.warning {
      background: #fef3c7;
      color: #d97706;
    }

    .status-badge.failed {
      background: #fee2e2;
      color: #dc2626;
    }

    .no-reports {
      text-align: center;
      color: #6b7280;
      padding: 40px;
    }

    .error {
      color: #dc2626;
      text-align: center;
      padding: 20px;
    }
  </style>
</body>
</html>