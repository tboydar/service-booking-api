<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>K6 æ•ˆèƒ½æ¸¬è©¦ - Service Booking API</title>
  <link rel="stylesheet" href="/admin/css/admin.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="admin-wrapper">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <h3>ğŸ¯ ç®¡ç†å¾Œå°</h3>
      </div>
      <ul class="sidebar-menu">
        <li><a href="/admin/dashboard">ğŸ“Š å„€è¡¨æ¿</a></li>
        <li><a href="/admin/system">ğŸ’» ç³»çµ±ç›£æ§</a></li>
        <li><a href="/admin/logs">ğŸ“ æ—¥èªŒç®¡ç†</a></li>
        <li><a href="/admin/scheduler">â° æ’ç¨‹ç®¡ç†</a></li>
        <li><a href="/admin/k6-test" class="active">ğŸš€ K6 æ•ˆèƒ½æ¸¬è©¦</a></li>
        <li><a href="/admin/services">ğŸ“¦ æœå‹™ç®¡ç†</a></li>
        <li><a href="/admin/users">ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</a></li>
        <li><a href="#" id="logoutBtn">ğŸšª ç™»å‡º</a></li>
      </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="header">
        <h1>ğŸš€ K6 æ•ˆèƒ½æ¸¬è©¦</h1>
        <button id="refreshReports" class="btn btn-secondary">ğŸ”„ é‡æ–°æ•´ç†</button>
      </div>

      <!-- Test Plans -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ğŸ“‹ æ¸¬è©¦è¨ˆåŠƒ</h2>
        </div>
        <div class="card-body">
          <div class="test-plans-grid">
            <!-- Smoke Test -->
            <div class="test-plan">
              <div class="test-plan-header">
                <h3>ğŸ’¨ ç…™éœ§æ¸¬è©¦ (Smoke Test)</h3>
                <span class="test-badge smoke">åŸºç¤æ¸¬è©¦</span>
              </div>
              <div class="test-plan-body">
                <p><strong>ç›®çš„ï¼š</strong>é©—è­‰ç³»çµ±åŸºæœ¬åŠŸèƒ½æ˜¯å¦æ­£å¸¸é‹ä½œ</p>
                <p><strong>è™›æ“¬ç”¨æˆ¶ï¼š</strong>3 å€‹</p>
                <p><strong>æ¸¬è©¦æ™‚é–“ï¼š</strong>1 åˆ†é˜</p>
                <p><strong>æ¸¬è©¦é …ç›®ï¼š</strong></p>
                <ul>
                  <li>å¥åº·æª¢æŸ¥ (Health Check)</li>
                  <li>ç”¨æˆ¶è¨»å†Š</li>
                  <li>ç”¨æˆ¶ç™»å…¥</li>
                  <li>å–å¾—æœå‹™åˆ—è¡¨</li>
                  <li>å»ºç«‹æœå‹™é ç´„</li>
                </ul>
                <p><strong>æˆåŠŸæ¢ä»¶ï¼š</strong></p>
                <ul>
                  <li>95% è«‹æ±‚éŸ¿æ‡‰æ™‚é–“ < 500ms</li>
                  <li>éŒ¯èª¤ç‡ < 10%</li>
                </ul>
              </div>
              <div class="test-plan-footer">
                <button class="btn btn-primary" onclick="runTest('smoke')">ğŸƒâ€â™‚ï¸ åŸ·è¡Œæ¸¬è©¦</button>
                <a href="/k6/scenarios/smoke-test.js" target="_blank" class="btn btn-secondary">ğŸ“„ æŸ¥çœ‹è…³æœ¬</a>
              </div>
            </div>

            <!-- Load Test -->
            <div class="test-plan">
              <div class="test-plan-header">
                <h3>ğŸ“ˆ è² è¼‰æ¸¬è©¦ (Load Test)</h3>
                <span class="test-badge load">è² è¼‰æ¸¬è©¦</span>
              </div>
              <div class="test-plan-body">
                <p><strong>ç›®çš„ï¼š</strong>æ¸¬è©¦ç³»çµ±åœ¨é æœŸè² è¼‰ä¸‹çš„æ€§èƒ½è¡¨ç¾</p>
                <p><strong>è™›æ“¬ç”¨æˆ¶ï¼š</strong>10-50 å€‹ï¼ˆéšæ®µå¼å¢åŠ ï¼‰</p>
                <p><strong>æ¸¬è©¦æ™‚é–“ï¼š</strong>5 åˆ†é˜</p>
                <p><strong>æ¸¬è©¦éšæ®µï¼š</strong></p>
                <ul>
                  <li>éšæ®µ1ï¼š10 ç”¨æˆ¶ (2åˆ†é˜)</li>
                  <li>éšæ®µ2ï¼š25 ç”¨æˆ¶ (2åˆ†é˜)</li>
                  <li>éšæ®µ3ï¼š50 ç”¨æˆ¶ (1åˆ†é˜)</li>
                </ul>
                <p><strong>æˆåŠŸæ¢ä»¶ï¼š</strong></p>
                <ul>
                  <li>å¹³å‡éŸ¿æ‡‰æ™‚é–“ < 1000ms</li>
                  <li>95% è«‹æ±‚éŸ¿æ‡‰æ™‚é–“ < 2000ms</li>
                  <li>éŒ¯èª¤ç‡ < 5%</li>
                </ul>
              </div>
              <div class="test-plan-footer">
                <button class="btn btn-primary" onclick="runTest('load')">ğŸƒâ€â™‚ï¸ åŸ·è¡Œæ¸¬è©¦</button>
                <a href="/k6/scenarios/load-test.js" target="_blank" class="btn btn-secondary">ğŸ“„ æŸ¥çœ‹è…³æœ¬</a>
              </div>
            </div>

            <!-- Stress Test -->
            <div class="test-plan">
              <div class="test-plan-header">
                <h3>ğŸ’ª å£“åŠ›æ¸¬è©¦ (Stress Test)</h3>
                <span class="test-badge stress">å£“åŠ›æ¸¬è©¦</span>
              </div>
              <div class="test-plan-body">
                <p><strong>ç›®çš„ï¼š</strong>æ¸¬è©¦ç³»çµ±åœ¨æ¥µé™è² è¼‰ä¸‹çš„è¡¨ç¾å’Œæ¢å¾©èƒ½åŠ›</p>
                <p><strong>è™›æ“¬ç”¨æˆ¶ï¼š</strong>10-100 å€‹ï¼ˆéšæ®µå¼å¢åŠ ï¼‰</p>
                <p><strong>æ¸¬è©¦æ™‚é–“ï¼š</strong>10 åˆ†é˜</p>
                <p><strong>æ¸¬è©¦éšæ®µï¼š</strong></p>
                <ul>
                  <li>éšæ®µ1ï¼šçˆ¬å‡è‡³ 50 ç”¨æˆ¶ (2åˆ†é˜)</li>
                  <li>éšæ®µ2ï¼šç¶­æŒ 50 ç”¨æˆ¶ (2åˆ†é˜)</li>
                  <li>éšæ®µ3ï¼šçˆ¬å‡è‡³ 100 ç”¨æˆ¶ (2åˆ†é˜)</li>
                  <li>éšæ®µ4ï¼šç¶­æŒ 100 ç”¨æˆ¶ (2åˆ†é˜)</li>
                  <li>éšæ®µ5ï¼šé™å› 10 ç”¨æˆ¶ (2åˆ†é˜)</li>
                </ul>
                <p><strong>è§€å¯ŸæŒ‡æ¨™ï¼š</strong></p>
                <ul>
                  <li>ç³»çµ±ç ´å£é» (Breaking Point)</li>
                  <li>éŒ¯èª¤ç‡è®ŠåŒ–</li>
                  <li>éŸ¿æ‡‰æ™‚é–“è®ŠåŒ–</li>
                  <li>ç³»çµ±æ¢å¾©æ™‚é–“</li>
                </ul>
              </div>
              <div class="test-plan-footer">
                <button class="btn btn-primary" onclick="runTest('stress')">ğŸƒâ€â™‚ï¸ åŸ·è¡Œæ¸¬è©¦</button>
                <a href="/k6/scenarios/stress-test.js" target="_blank" class="btn btn-secondary">ğŸ“„ æŸ¥çœ‹è…³æœ¬</a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Test Execution -->
      <div class="card" id="testExecutionCard" style="display: none;">
        <div class="card-header">
          <h2 class="card-title">âš¡ æ¸¬è©¦åŸ·è¡Œä¸­</h2>
        </div>
        <div class="card-body">
          <div class="test-progress">
            <div class="progress-info">
              <h3 id="runningTestName">æ¸¬è©¦åç¨±</h3>
              <p id="testStatus">æº–å‚™ä¸­...</p>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar">
                <div class="progress-fill" id="testProgress" style="width: 0%"></div>
              </div>
              <span id="progressText">0%</span>
            </div>
            <div class="test-output">
              <h4>æ¸¬è©¦è¼¸å‡ºï¼š</h4>
              <pre id="testOutput">ç­‰å¾…æ¸¬è©¦é–‹å§‹...</pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Test Reports -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ğŸ“Š æ¸¬è©¦å ±å‘Š</h2>
        </div>
        <div class="card-body">
          <div id="reportsContainer">
            <p>è¼‰å…¥æ¸¬è©¦å ±å‘Šä¸­...</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="/admin/js/admin.js"></script>
  <script>
    let currentTest = null;
    let testInterval = null;

    // Load test reports
    async function loadReports() {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch('/admin/api/k6/reports', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load reports');
        }

        const result = await response.json();
        if (result.success) {
          displayReports(result.data.reports || []);
        }
      } catch (error) {
        console.error('Error loading reports:', error);
        document.getElementById('reportsContainer').innerHTML =
          '<p class="error">ç„¡æ³•è¼‰å…¥æ¸¬è©¦å ±å‘Š</p>';
      }
    }

    // Display reports
    function displayReports(reports) {
      const container = document.getElementById('reportsContainer');

      if (reports.length === 0) {
        container.innerHTML = '<p class="no-reports">ç›®å‰æ²’æœ‰æ¸¬è©¦å ±å‘Š</p>';
        return;
      }

      container.innerHTML = reports.map(report => `
        <div class="report-card">
          <div class="report-header">
            <h3>${report.testType.toUpperCase()} æ¸¬è©¦</h3>
            <span class="report-date">${new Date(report.timestamp).toLocaleString('zh-TW')}</span>
          </div>
          <div class="report-metrics">
            <div class="metric">
              <span class="metric-label">ç¸½è«‹æ±‚æ•¸</span>
              <span class="metric-value">${report.metrics.http_reqs || 0}</span>
            </div>
            <div class="metric">
              <span class="metric-label">å¹³å‡éŸ¿æ‡‰æ™‚é–“</span>
              <span class="metric-value">${(report.metrics.http_req_duration_avg || 0).toFixed(2)}ms</span>
            </div>
            <div class="metric">
              <span class="metric-label">95% éŸ¿æ‡‰æ™‚é–“</span>
              <span class="metric-value">${(report.metrics.http_req_duration_p95 || 0).toFixed(2)}ms</span>
            </div>
            <div class="metric">
              <span class="metric-label">éŒ¯èª¤ç‡</span>
              <span class="metric-value ${(report.metrics.http_req_failed_rate || 0) > 0.05 ? 'error' : 'success'}">
                ${((report.metrics.http_req_failed_rate || 0) * 100).toFixed(2)}%
              </span>
            </div>
            <div class="metric">
              <span class="metric-label">æ¸¬è©¦æ™‚é•·</span>
              <span class="metric-value">${Math.round(report.duration || 0)}s</span>
            </div>
            <div class="metric">
              <span class="metric-label">è™›æ“¬ç”¨æˆ¶</span>
              <span class="metric-value">${report.metrics.vus_max || 0}</span>
            </div>
          </div>
          <div class="report-status">
            <span class="status-badge ${getTestStatus(report.metrics)}">
              ${getTestStatusText(report.metrics)}
            </span>
          </div>
        </div>
      `).join('');
    }

    // Get test status
    function getTestStatus(metrics) {
      const errorRate = metrics.http_req_failed_rate || 0;
      const p95Duration = metrics.http_req_duration_p95 || 0;

      if (errorRate > 0.1 || p95Duration > 5000) return 'failed';
      if (errorRate > 0.05 || p95Duration > 2000) return 'warning';
      return 'passed';
    }

    // Get test status text
    function getTestStatusText(metrics) {
      const status = getTestStatus(metrics);
      const statusMap = {
        'passed': 'é€šé',
        'warning': 'è­¦å‘Š',
        'failed': 'å¤±æ•—'
      };
      return statusMap[status] || 'æœªçŸ¥';
    }

    // Run test
    async function runTest(testType) {
      if (currentTest) {
        alert('å·²æœ‰æ¸¬è©¦åœ¨åŸ·è¡Œä¸­ï¼Œè«‹ç­‰å¾…å®Œæˆ');
        return;
      }

      try {
        currentTest = testType;
        showTestExecution(testType);

        const token = localStorage.getItem('adminToken');
        const response = await fetch('/admin/api/k6/run', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ testType })
        });

        if (!response.ok) {
          throw new Error('Failed to start test');
        }

        const result = await response.json();
        if (result.success) {
          // Start monitoring test progress
          monitorTestProgress(result.data.testId);
        } else {
          throw new Error(result.error?.message || 'Test failed to start');
        }
      } catch (error) {
        console.error('Error running test:', error);
        alert('ç„¡æ³•å•Ÿå‹•æ¸¬è©¦: ' + error.message);
        hideTestExecution();
      }
    }

    // Show test execution UI
    function showTestExecution(testType) {
      const testNames = {
        smoke: 'ç…™éœ§æ¸¬è©¦',
        load: 'è² è¼‰æ¸¬è©¦',
        stress: 'å£“åŠ›æ¸¬è©¦'
      };

      document.getElementById('runningTestName').textContent = testNames[testType] || testType;
      document.getElementById('testStatus').textContent = 'æ¸¬è©¦å•Ÿå‹•ä¸­...';
      document.getElementById('testProgress').style.width = '0%';
      document.getElementById('progressText').textContent = '0%';
      document.getElementById('testOutput').textContent = 'ç­‰å¾…æ¸¬è©¦é–‹å§‹...\n';
      document.getElementById('testExecutionCard').style.display = 'block';
    }

    // Hide test execution UI
    function hideTestExecution() {
      document.getElementById('testExecutionCard').style.display = 'none';
      currentTest = null;
      if (testInterval) {
        clearInterval(testInterval);
        testInterval = null;
      }
    }

    // Monitor test progress (simulated)
    function monitorTestProgress(testId) {
      let progress = 0;
      const duration = getTestDuration(currentTest);
      const updateInterval = 1000; // 1 second
      const totalUpdates = Math.floor(duration / updateInterval);

      testInterval = setInterval(() => {
        progress += 100 / totalUpdates;

        if (progress >= 100) {
          progress = 100;
          document.getElementById('testStatus').textContent = 'æ¸¬è©¦å®Œæˆ';
          document.getElementById('testOutput').textContent += '\nâœ… æ¸¬è©¦åŸ·è¡Œå®Œæˆï¼Œæ­£åœ¨ç”Ÿæˆå ±å‘Š...';

          setTimeout(() => {
            hideTestExecution();
            loadReports();
          }, 2000);

          clearInterval(testInterval);
          testInterval = null;
        } else {
          document.getElementById('testStatus').textContent = 'æ¸¬è©¦åŸ·è¡Œä¸­...';
          document.getElementById('testOutput').textContent += `.`;
        }

        document.getElementById('testProgress').style.width = `${progress}%`;
        document.getElementById('progressText').textContent = `${Math.round(progress)}%`;
      }, updateInterval);
    }

    // Get test duration
    function getTestDuration(testType) {
      const durations = {
        smoke: 60000,  // 1 minute
        load: 300000,  // 5 minutes
        stress: 600000 // 10 minutes
      };
      return durations[testType] || 60000;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadReports();

      // Event listeners
      document.getElementById('refreshReports').addEventListener('click', loadReports);

      // Initialize admin dashboard
      if (typeof AdminDashboard !== 'undefined') {
        AdminDashboard.init();
      }
    });
  </script>

  <style>
    .test-plans-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .test-plan {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      background: white;
    }

    .test-plan-header {
      padding: 20px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .test-plan-body {
      padding: 20px;
    }

    .test-plan-footer {
      padding: 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 10px;
    }

    .test-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .test-badge.smoke {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .test-badge.load {
      background: #fef3c7;
      color: #d97706;
    }

    .test-badge.stress {
      background: #fee2e2;
      color: #dc2626;
    }

    .test-progress {
      text-align: center;
    }

    .progress-info {
      margin-bottom: 20px;
    }

    .progress-bar-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .progress-bar {
      flex: 1;
      height: 20px;
      background: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #2563eb);
      transition: width 0.3s ease;
    }

    .test-output {
      background: #1f2937;
      color: #f3f4f6;
      padding: 20px;
      border-radius: 8px;
      text-align: left;
    }

    .test-output pre {
      margin: 0;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }

    .report-card {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      background: white;
    }

    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e5e7eb;
    }

    .report-date {
      color: #6b7280;
      font-size: 14px;
    }

    .report-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .metric {
      text-align: center;
    }

    .metric-label {
      display: block;
      color: #6b7280;
      font-size: 12px;
      margin-bottom: 5px;
    }

    .metric-value {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
    }

    .metric-value.error {
      color: #dc2626;
    }

    .metric-value.success {
      color: #059669;
    }

    .report-status {
      text-align: center;
    }

    .status-badge {
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-badge.passed {
      background: #d1fae5;
      color: #059669;
    }

    .status-badge.warning {
      background: #fef3c7;
      color: #d97706;
    }

    .status-badge.failed {
      background: #fee2e2;
      color: #dc2626;
    }

    .no-reports {
      text-align: center;
      color: #6b7280;
      padding: 40px;
    }

    .error {
      color: #dc2626;
      text-align: center;
      padding: 20px;
    }
  </style>
</body>
</html>