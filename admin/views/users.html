<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”¨æˆ¶ç®¡ç† - Service Booking API</title>
  <link rel="stylesheet" href="/admin/css/admin.css">
</head>
<body>
  <div class="admin-wrapper">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <h3>ğŸ¯ ç®¡ç†å¾Œå°</h3>
      </div>
      <ul class="sidebar-menu">
        <li><a href="/admin/dashboard">ğŸ“Š å„€è¡¨æ¿</a></li>
        <li><a href="/admin/system">ğŸ’» ç³»çµ±ç›£æ§</a></li>
        <li><a href="/admin/logs">ğŸ“ æ—¥èªŒç®¡ç†</a></li>
        <li><a href="/admin/scheduler">â° æ’ç¨‹ç®¡ç†</a></li>
        <li><a href="/admin/k6-test">ğŸš€ K6 æ•ˆèƒ½æ¸¬è©¦</a></li>
        <li><a href="/admin/services">ğŸ“¦ æœå‹™ç®¡ç†</a></li>
        <li><a href="/admin/users" class="active">ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</a></li>
        <li><a href="#" id="logoutBtn">ğŸšª ç™»å‡º</a></li>
      </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="header">
        <h1>ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</h1>
        <button id="refreshUsers" class="btn btn-secondary">ğŸ”„ é‡æ–°æ•´ç†</button>
      </div>

      <!-- User Statistics -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>ğŸ‘¥ ç¸½ç”¨æˆ¶æ•¸</h3>
          <p class="stat-value" id="totalUsers">0</p>
        </div>
        <div class="stat-card success">
          <h3>âœ… æ´»èºç”¨æˆ¶</h3>
          <p class="stat-value" id="activeUsers">0</p>
        </div>
        <div class="stat-card info">
          <h3>ğŸ†• æœ¬æœˆæ–°ç”¨æˆ¶</h3>
          <p class="stat-value" id="newUsers">0</p>
        </div>
        <div class="stat-card warning">
          <h3>ğŸ‘‘ ç®¡ç†å“¡</h3>
          <p class="stat-value" id="adminUsers">0</p>
        </div>
      </div>

      <!-- Search and Filter -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ğŸ” æœå°‹èˆ‡ç¯©é¸</h2>
        </div>
        <div class="card-body">
          <div class="filter-grid">
            <div class="form-group">
              <label for="searchInput">æœå°‹ç”¨æˆ¶</label>
              <input type="text" id="searchInput" class="form-control" placeholder="è¼¸å…¥å§“åæˆ– Email...">
            </div>
            <div class="form-group">
              <label for="roleFilter">è§’è‰²ç¯©é¸</label>
              <select id="roleFilter" class="form-control">
                <option value="">å…¨éƒ¨è§’è‰²</option>
                <option value="admin">ç®¡ç†å“¡</option>
                <option value="user">ä¸€èˆ¬ç”¨æˆ¶</option>
              </select>
            </div>
            <div class="form-group">
              <label for="statusFilter">ç‹€æ…‹ç¯©é¸</label>
              <select id="statusFilter" class="form-control">
                <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                <option value="active">æ´»èº</option>
                <option value="inactive">éæ´»èº</option>
              </select>
            </div>
            <div class="form-group">
              <label>&nbsp;</label>
              <button id="applyFilter" class="btn btn-primary">å¥—ç”¨ç¯©é¸</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Users List -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ğŸ“‹ ç”¨æˆ¶åˆ—è¡¨</h2>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>å§“å</th>
                  <th>Email</th>
                  <th>è§’è‰²</th>
                  <th>è¨»å†Šæ™‚é–“</th>
                  <th>æœ€å¾Œç™»å…¥</th>
                  <th>é ç´„æ¬¡æ•¸</th>
                  <th>ç‹€æ…‹</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <tr>
                  <td colspan="9" class="text-center">è¼‰å…¥ç”¨æˆ¶ä¸­...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="pagination">
            <button id="prevPage" class="btn btn-secondary" disabled>ä¸Šä¸€é </button>
            <span id="pageInfo">ç¬¬ 1 é ï¼Œå…± 1 é </span>
            <button id="nextPage" class="btn btn-secondary">ä¸‹ä¸€é </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="/admin/js/admin.js"></script>
  <script>
    let users = [];
    let filteredUsers = [];
    let currentPage = 1;
    let totalPages = 1;
    const pageSize = 20;

    // Load users - simulation since we don't have a real users API
    async function loadUsers() {
      try {
        // Simulate loading users from database
        // In a real implementation, this would call /admin/api/users
        users = generateMockUsers();
        applyFilters();
        updateStatistics();
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersTableBody').innerHTML =
          '<tr><td colspan="9" class="text-center error">ç„¡æ³•è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨</td></tr>';
      }
    }

    // Generate mock users for demonstration
    function generateMockUsers() {
      const mockUsers = [
        {
          id: '1',
          name: 'ç³»çµ±ç®¡ç†å“¡',
          email: 'admin@example.com',
          role: 'admin',
          createdAt: '2025-01-01T00:00:00Z',
          lastLogin: '2025-09-17T05:00:00Z',
          bookingCount: 0,
          isActive: true
        },
        {
          id: '2',
          name: 'å¼µå°æ˜',
          email: 'ming@example.com',
          role: 'user',
          createdAt: '2025-02-15T10:30:00Z',
          lastLogin: '2025-09-16T14:20:00Z',
          bookingCount: 5,
          isActive: true
        },
        {
          id: '3',
          name: 'æç¾è¯',
          email: 'mei@example.com',
          role: 'user',
          createdAt: '2025-03-10T08:15:00Z',
          lastLogin: '2025-09-15T09:45:00Z',
          bookingCount: 12,
          isActive: true
        },
        {
          id: '4',
          name: 'ç‹å¿—å‰',
          email: 'wang@example.com',
          role: 'user',
          createdAt: '2025-04-05T16:22:00Z',
          lastLogin: '2025-08-20T11:30:00Z',
          bookingCount: 3,
          isActive: false
        },
        {
          id: '5',
          name: 'é™³é›…å©·',
          email: 'chen@example.com',
          role: 'user',
          createdAt: '2025-08-20T13:45:00Z',
          lastLogin: '2025-09-17T08:10:00Z',
          bookingCount: 1,
          isActive: true
        }
      ];

      return mockUsers;
    }

    // Apply filters
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const roleFilter = document.getElementById('roleFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;

      filteredUsers = users.filter(user => {
        // Search filter
        if (searchTerm) {
          const searchIn = `${user.name} ${user.email}`.toLowerCase();
          if (!searchIn.includes(searchTerm)) return false;
        }

        // Role filter
        if (roleFilter && user.role !== roleFilter) return false;

        // Status filter
        if (statusFilter) {
          if (statusFilter === 'active' && !user.isActive) return false;
          if (statusFilter === 'inactive' && user.isActive) return false;
        }

        return true;
      });

      currentPage = 1;
      displayUsers();
    }

    // Display users
    function displayUsers() {
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageUsers = filteredUsers.slice(start, end);

      const tbody = document.getElementById('usersTableBody');

      if (pageUsers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç”¨æˆ¶</td></tr>';
        return;
      }

      tbody.innerHTML = pageUsers.map(user => `
        <tr>
          <td>${user.id}</td>
          <td>${escapeHtml(user.name)}</td>
          <td>${escapeHtml(user.email)}</td>
          <td>
            <span class="badge ${user.role === 'admin' ? 'badge-admin' : 'badge-user'}">
              ${user.role === 'admin' ? 'ç®¡ç†å“¡' : 'ä¸€èˆ¬ç”¨æˆ¶'}
            </span>
          </td>
          <td>${new Date(user.createdAt).toLocaleDateString('zh-TW')}</td>
          <td>${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('zh-TW') : 'å¾æœªç™»å…¥'}</td>
          <td>${user.bookingCount}</td>
          <td>
            <span class="badge ${user.isActive ? 'badge-success' : 'badge-warning'}">
              ${user.isActive ? 'æ´»èº' : 'éæ´»èº'}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-sm" onclick="viewUserDetail('${user.id}')">ğŸ‘ï¸ æŸ¥çœ‹</button>
              <button class="btn btn-sm" onclick="editUser('${user.id}')">âœï¸ ç·¨è¼¯</button>
              ${user.role !== 'admin' ? `
                <button class="btn btn-sm ${user.isActive ? 'btn-warning' : 'btn-success'}"
                        onclick="toggleUserStatus('${user.id}', ${!user.isActive})">
                  ${user.isActive ? 'åœç”¨' : 'å•Ÿç”¨'}
                </button>
              ` : ''}
            </div>
          </td>
        </tr>
      `).join('');

      // Update pagination
      totalPages = Math.ceil(filteredUsers.length / pageSize);
      document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} é ï¼Œå…± ${totalPages} é `;
      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = currentPage === totalPages;
    }

    // Update statistics
    function updateStatistics() {
      const stats = {
        total: users.length,
        active: users.filter(u => u.isActive).length,
        newThisMonth: users.filter(u => {
          const userDate = new Date(u.createdAt);
          const now = new Date();
          return userDate.getMonth() === now.getMonth() && userDate.getFullYear() === now.getFullYear();
        }).length,
        admins: users.filter(u => u.role === 'admin').length
      };

      document.getElementById('totalUsers').textContent = stats.total;
      document.getElementById('activeUsers').textContent = stats.active;
      document.getElementById('newUsers').textContent = stats.newThisMonth;
      document.getElementById('adminUsers').textContent = stats.admins;
    }

    // View user detail
    function viewUserDetail(userId) {
      const user = users.find(u => u.id === userId);
      if (!user) return;

      alert(`ç”¨æˆ¶è©³ç´°è³‡è¨Šï¼š
å§“åï¼š${user.name}
Emailï¼š${user.email}
è§’è‰²ï¼š${user.role === 'admin' ? 'ç®¡ç†å“¡' : 'ä¸€èˆ¬ç”¨æˆ¶'}
è¨»å†Šæ™‚é–“ï¼š${new Date(user.createdAt).toLocaleString('zh-TW')}
æœ€å¾Œç™»å…¥ï¼š${user.lastLogin ? new Date(user.lastLogin).toLocaleString('zh-TW') : 'å¾æœªç™»å…¥'}
é ç´„æ¬¡æ•¸ï¼š${user.bookingCount}
ç‹€æ…‹ï¼š${user.isActive ? 'æ´»èº' : 'éæ´»èº'}`);
    }

    // Edit user
    function editUser(userId) {
      alert('ç·¨è¼¯ç”¨æˆ¶åŠŸèƒ½é–‹ç™¼ä¸­...');
    }

    // Toggle user status
    function toggleUserStatus(userId, newStatus) {
      const user = users.find(u => u.id === userId);
      if (!user) return;

      if (confirm(`ç¢ºå®šè¦${newStatus ? 'å•Ÿç”¨' : 'åœç”¨'}ç”¨æˆ¶ã€Œ${user.name}ã€å—ï¼Ÿ`)) {
        user.isActive = newStatus;
        displayUsers();
        updateStatistics();
        alert(`ç”¨æˆ¶å·²${newStatus ? 'å•Ÿç”¨' : 'åœç”¨'}`);
      }
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadUsers();

      // Event listeners
      document.getElementById('refreshUsers').addEventListener('click', loadUsers);
      document.getElementById('applyFilter').addEventListener('click', applyFilters);
      document.getElementById('searchInput').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') applyFilters();
      });

      document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          displayUsers();
        }
      });

      document.getElementById('nextPage').addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          displayUsers();
        }
      });

      // Initialize admin dashboard
      if (typeof AdminDashboard !== 'undefined') {
        AdminDashboard.init();
      }
    });
  </script>

  <style>
    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      align-items: end;
    }

    .table-container {
      overflow-x: auto;
      margin-bottom: 20px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    .data-table th {
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-admin {
      background: #ef4444;
      color: white;
    }

    .badge-user {
      background: #3b82f6;
      color: white;
    }

    .badge-success {
      background: #10b981;
      color: white;
    }

    .badge-warning {
      background: #f59e0b;
      color: white;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-top: 20px;
    }

    .stat-card.success {
      background: #d1fae5;
    }

    .stat-card.info {
      background: #dbeafe;
    }

    .stat-card.warning {
      background: #fef3c7;
    }

    .text-center {
      text-align: center;
    }

    .error {
      color: #dc2626;
    }
  </style>
</body>
</html>