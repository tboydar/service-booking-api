<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>用戶管理 - Service Booking API</title>
  <link rel="stylesheet" href="/admin/css/admin.css">
</head>
<body>
  <div class="admin-wrapper">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <h3>🎯 管理後台</h3>
      </div>
      <ul class="sidebar-menu">
        <li><a href="/admin/dashboard">📊 儀表板</a></li>
        <li><a href="/admin/system">💻 系統監控</a></li>
        <li><a href="/admin/logs">📝 日誌管理</a></li>
        <li><a href="/admin/scheduler">⏰ 排程管理</a></li>
        <li><a href="/admin/k6-test">🚀 K6 效能測試</a></li>
        <li><a href="/admin/services">📦 服務管理</a></li>
        <li><a href="/admin/users" class="active">👥 用戶管理</a></li>
        <li><a href="#" id="logoutBtn">🚪 登出</a></li>
      </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="header">
        <h1>👥 用戶管理</h1>
        <button id="refreshUsers" class="btn btn-secondary">🔄 重新整理</button>
      </div>

      <!-- User Statistics -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>👥 總用戶數</h3>
          <p class="stat-value" id="totalUsers">0</p>
        </div>
        <div class="stat-card success">
          <h3>✅ 活躍用戶</h3>
          <p class="stat-value" id="activeUsers">0</p>
        </div>
        <div class="stat-card info">
          <h3>🆕 本月新用戶</h3>
          <p class="stat-value" id="newUsers">0</p>
        </div>
        <div class="stat-card warning">
          <h3>👑 管理員</h3>
          <p class="stat-value" id="adminUsers">0</p>
        </div>
      </div>

      <!-- Search and Filter -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">🔍 搜尋與篩選</h2>
        </div>
        <div class="card-body">
          <div class="filter-grid">
            <div class="form-group">
              <label for="searchInput">搜尋用戶</label>
              <input type="text" id="searchInput" class="form-control" placeholder="輸入姓名或 Email...">
            </div>
            <div class="form-group">
              <label for="roleFilter">角色篩選</label>
              <select id="roleFilter" class="form-control">
                <option value="">全部角色</option>
                <option value="admin">管理員</option>
                <option value="user">一般用戶</option>
              </select>
            </div>
            <div class="form-group">
              <label for="statusFilter">狀態篩選</label>
              <select id="statusFilter" class="form-control">
                <option value="">全部狀態</option>
                <option value="active">活躍</option>
                <option value="inactive">非活躍</option>
              </select>
            </div>
            <div class="form-group">
              <label>&nbsp;</label>
              <button id="applyFilter" class="btn btn-primary">套用篩選</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Users List -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">📋 用戶列表</h2>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>姓名</th>
                  <th>Email</th>
                  <th>角色</th>
                  <th>註冊時間</th>
                  <th>最後登入</th>
                  <th>預約次數</th>
                  <th>狀態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <tr>
                  <td colspan="9" class="text-center">載入用戶中...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="pagination">
            <button id="prevPage" class="btn btn-secondary" disabled>上一頁</button>
            <span id="pageInfo">第 1 頁，共 1 頁</span>
            <button id="nextPage" class="btn btn-secondary">下一頁</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="/admin/js/admin.js"></script>
  <script>
    let users = [];
    let filteredUsers = [];
    let currentPage = 1;
    let totalPages = 1;
    const pageSize = 20;

    // Load users - simulation since we don't have a real users API
    async function loadUsers() {
      try {
        // Simulate loading users from database
        // In a real implementation, this would call /admin/api/users
        users = generateMockUsers();
        applyFilters();
        updateStatistics();
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersTableBody').innerHTML =
          '<tr><td colspan="9" class="text-center error">無法載入用戶列表</td></tr>';
      }
    }

    // Generate mock users for demonstration
    function generateMockUsers() {
      const mockUsers = [
        {
          id: '1',
          name: '系統管理員',
          email: 'admin@example.com',
          role: 'admin',
          createdAt: '2025-01-01T00:00:00Z',
          lastLogin: '2025-09-17T05:00:00Z',
          bookingCount: 0,
          isActive: true
        },
        {
          id: '2',
          name: '張小明',
          email: 'ming@example.com',
          role: 'user',
          createdAt: '2025-02-15T10:30:00Z',
          lastLogin: '2025-09-16T14:20:00Z',
          bookingCount: 5,
          isActive: true
        },
        {
          id: '3',
          name: '李美華',
          email: 'mei@example.com',
          role: 'user',
          createdAt: '2025-03-10T08:15:00Z',
          lastLogin: '2025-09-15T09:45:00Z',
          bookingCount: 12,
          isActive: true
        },
        {
          id: '4',
          name: '王志偉',
          email: 'wang@example.com',
          role: 'user',
          createdAt: '2025-04-05T16:22:00Z',
          lastLogin: '2025-08-20T11:30:00Z',
          bookingCount: 3,
          isActive: false
        },
        {
          id: '5',
          name: '陳雅婷',
          email: 'chen@example.com',
          role: 'user',
          createdAt: '2025-08-20T13:45:00Z',
          lastLogin: '2025-09-17T08:10:00Z',
          bookingCount: 1,
          isActive: true
        }
      ];

      return mockUsers;
    }

    // Apply filters
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const roleFilter = document.getElementById('roleFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;

      filteredUsers = users.filter(user => {
        // Search filter
        if (searchTerm) {
          const searchIn = `${user.name} ${user.email}`.toLowerCase();
          if (!searchIn.includes(searchTerm)) return false;
        }

        // Role filter
        if (roleFilter && user.role !== roleFilter) return false;

        // Status filter
        if (statusFilter) {
          if (statusFilter === 'active' && !user.isActive) return false;
          if (statusFilter === 'inactive' && user.isActive) return false;
        }

        return true;
      });

      currentPage = 1;
      displayUsers();
    }

    // Display users
    function displayUsers() {
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageUsers = filteredUsers.slice(start, end);

      const tbody = document.getElementById('usersTableBody');

      if (pageUsers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center">沒有找到符合條件的用戶</td></tr>';
        return;
      }

      tbody.innerHTML = pageUsers.map(user => `
        <tr>
          <td>${user.id}</td>
          <td>${escapeHtml(user.name)}</td>
          <td>${escapeHtml(user.email)}</td>
          <td>
            <span class="badge ${user.role === 'admin' ? 'badge-admin' : 'badge-user'}">
              ${user.role === 'admin' ? '管理員' : '一般用戶'}
            </span>
          </td>
          <td>${new Date(user.createdAt).toLocaleDateString('zh-TW')}</td>
          <td>${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('zh-TW') : '從未登入'}</td>
          <td>${user.bookingCount}</td>
          <td>
            <span class="badge ${user.isActive ? 'badge-success' : 'badge-warning'}">
              ${user.isActive ? '活躍' : '非活躍'}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-sm" onclick="viewUserDetail('${user.id}')">👁️ 查看</button>
              <button class="btn btn-sm" onclick="editUser('${user.id}')">✏️ 編輯</button>
              ${user.role !== 'admin' ? `
                <button class="btn btn-sm ${user.isActive ? 'btn-warning' : 'btn-success'}"
                        onclick="toggleUserStatus('${user.id}', ${!user.isActive})">
                  ${user.isActive ? '停用' : '啟用'}
                </button>
              ` : ''}
            </div>
          </td>
        </tr>
      `).join('');

      // Update pagination
      totalPages = Math.ceil(filteredUsers.length / pageSize);
      document.getElementById('pageInfo').textContent = `第 ${currentPage} 頁，共 ${totalPages} 頁`;
      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = currentPage === totalPages;
    }

    // Update statistics
    function updateStatistics() {
      const stats = {
        total: users.length,
        active: users.filter(u => u.isActive).length,
        newThisMonth: users.filter(u => {
          const userDate = new Date(u.createdAt);
          const now = new Date();
          return userDate.getMonth() === now.getMonth() && userDate.getFullYear() === now.getFullYear();
        }).length,
        admins: users.filter(u => u.role === 'admin').length
      };

      document.getElementById('totalUsers').textContent = stats.total;
      document.getElementById('activeUsers').textContent = stats.active;
      document.getElementById('newUsers').textContent = stats.newThisMonth;
      document.getElementById('adminUsers').textContent = stats.admins;
    }

    // View user detail
    function viewUserDetail(userId) {
      const user = users.find(u => u.id === userId);
      if (!user) return;

      alert(`用戶詳細資訊：
姓名：${user.name}
Email：${user.email}
角色：${user.role === 'admin' ? '管理員' : '一般用戶'}
註冊時間：${new Date(user.createdAt).toLocaleString('zh-TW')}
最後登入：${user.lastLogin ? new Date(user.lastLogin).toLocaleString('zh-TW') : '從未登入'}
預約次數：${user.bookingCount}
狀態：${user.isActive ? '活躍' : '非活躍'}`);
    }

    // Edit user
    function editUser(userId) {
      alert('編輯用戶功能開發中...');
    }

    // Toggle user status
    function toggleUserStatus(userId, newStatus) {
      const user = users.find(u => u.id === userId);
      if (!user) return;

      if (confirm(`確定要${newStatus ? '啟用' : '停用'}用戶「${user.name}」嗎？`)) {
        user.isActive = newStatus;
        displayUsers();
        updateStatistics();
        alert(`用戶已${newStatus ? '啟用' : '停用'}`);
      }
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadUsers();

      // Event listeners
      document.getElementById('refreshUsers').addEventListener('click', loadUsers);
      document.getElementById('applyFilter').addEventListener('click', applyFilters);
      document.getElementById('searchInput').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') applyFilters();
      });

      document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          displayUsers();
        }
      });

      document.getElementById('nextPage').addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          displayUsers();
        }
      });

      // Initialize admin dashboard
      if (typeof AdminDashboard !== 'undefined') {
        AdminDashboard.init();
      }
    });
  </script>

  <style>
    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      align-items: end;
    }

    .table-container {
      overflow-x: auto;
      margin-bottom: 20px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    .data-table th {
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-admin {
      background: #ef4444;
      color: white;
    }

    .badge-user {
      background: #3b82f6;
      color: white;
    }

    .badge-success {
      background: #10b981;
      color: white;
    }

    .badge-warning {
      background: #f59e0b;
      color: white;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-top: 20px;
    }

    .stat-card.success {
      background: #d1fae5;
    }

    .stat-card.info {
      background: #dbeafe;
    }

    .stat-card.warning {
      background: #fef3c7;
    }

    .text-center {
      text-align: center;
    }

    .error {
      color: #dc2626;
    }
  </style>
</body>
</html>